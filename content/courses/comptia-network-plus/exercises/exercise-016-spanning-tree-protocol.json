{
  "id": "exercise-016-spanning-tree-protocol",
  "lessonId": "lesson-016-spanning-tree-protocol",
  "title": "Spanning Tree Protocol Lab",
  "description": "Apply Lesson 016 concepts to design, configure, and troubleshoot STP deployments across Meridian Logistics' multi-site network, optimizing root bridge placement, preventing loops, managing convergence, and implementing best practices so every switch topology stays stable and loop-free.",
  "difficulty": "advanced",
  "points": 120,
  "language": "text",
  "starterCode": "# Spanning Tree Protocol Lab - Root Bridge Election, Port Roles, RSTP, and Troubleshooting\n# Based on Lesson 016: Spanning Tree Protocol Deep Dive\n\n================================================================================\nSCENARIO 1: ROOT BRIDGE ELECTION AND PORT ROLE ASSIGNMENT\n================================================================================\nMeridian Logistics' main campus has three core switches (SW1, SW2, SW3) that form a redundant triangle topology. Each pair connects with two 1 Gbps links (total 4 links forming the triangle). The network currently has no manually configured STP priority, so switches are using their default priority of 32768.\n\nSwitch MAC Addresses:\n- SW1: 0000.0c9f.f001\n- SW2: 0000.0c9f.f002\n- SW3: 0000.0c9f.f003\n\nCurrent STP Status (using default 802.1D STP, not RSTP):\n- All switches report they are not the root bridge\n- No explicit root bridge configuration exists\n- Port states are stabilized with some ports in forwarding and some in blocking\n\nThe network is experiencing uneven traffic distribution. Sales team (on SW1) cannot reach Finance team (on SW3) through preferred path. Operations wants:\n1. SW1 to be the root bridge (it's most central)\n2. All ports documented with their roles and states\n3. Path costs calculated for validation\n4. Understanding of why default election chose the current root\n\nQUESTIONS:\n1. Based on Bridge ID calculation (Priority + MAC address), which switch became the root bridge using defaults? Show your calculation.\n2. For each non-root switch (if SW1 is manually set to priority 0), identify the root port, designated ports, and blocked/alternate ports. Explain the port role selection criteria (lowest root path cost, then lowest sender BID, etc.).\n3. What CLI commands on each switch prove which switch is root and show the root port on non-root switches?\n4. Calculate the root path cost for SW3 to reach SW1 through both possible paths (via SW2 and direct via SW3-SW1 link). Which path does STP prefer?\n5. If you manually configure SW1 as root with priority 0, what commands achieve this, and how do you verify the topology changed correctly?\n\n================================================================================\nSCENARIO 2: RSTP FAST CONVERGENCE VS. CLASSIC STP DELAYS\n================================================================================\nThe campus had a link failure yesterday. When the trunk between SW1 and SW2 went down, users experienced a 45-second outage before traffic recovered. The port that blocked the redundant SW3 link then transitioned through Blocking → Listening → Learning → Forwarding states. Management asks why connectivity took so long to restore.\n\nCurrent topology (post-failure, stabilized):\n- SW1 is root bridge\n- SW1-SW3: Active link (primary)\n- SW2-SW3: Now forwarding (was blocking before failure)\n- SW1-SW2: Down (link failure)\n\nQUESTIONS:\n1. Explain why classic STP (802.1D) required 45 seconds to restore the path through SW3. What are the three state transitions and their timers?\n2. What is the difference in convergence time if the campus upgrades to RSTP (Rapid PVST+) with the same topology? Describe the proposal/agreement mechanism that enables fast convergence.\n3. How would PortFast and BPDU Guard help prevent future outages if end devices disconnect and reconnect during link failures?\n4. Write the CLI commands to upgrade from STP to RSTP on all three switches and enable PortFast globally on access ports.\n5. After enabling RSTP, a user reports their workstation connected instantly (no delay). Which RSTP feature enabled this, and what is the risk if PortFast is enabled on a switch-to-switch link?\n\n================================================================================\nSCENARIO 3: STP ENHANCEMENTS - PORTFAST, BPDU GUARD, AND ROOT GUARD\n================================================================================\nA new IT director configured PortFast globally on all switches without understanding the implications. Moments later, a network technician accidentally connected a cable from an access port on SW1 to an access port on SW2 (user mistake, not intended trunk). This created a bridging loop. Simultaneously, a contractor plugged in their own managed switch to an access port, and that switch announced a lower Bridge ID, attempting to become the new root bridge.\n\nMeridian's network is now experiencing broadcast storms (100% CPU on switches), MAC table flapping, and complete service loss.\n\nQUESTIONS:\n1. Explain how the accidental loop between SW1 and SW2 access ports created broadcast storms even with STP enabled. Why didn't STP block one port immediately?\n2. Why was the contractor's switch able to become the root bridge so quickly? What STP vulnerability is exposed?\n3. Write the complete set of CLI commands to implement STP enhancements:\n   a. Re-enable BPDU Guard globally on all PortFast ports to prevent the loop\n   b. Manually configure SW1 as root with priority 0\n   c. Configure Root Guard on all uplink ports toward distribution layer\n   d. Enable Loop Guard on all point-to-point trunk links\n4. After fixing the immediate crisis with PortFast + BPDU Guard, why would the port go into err-disabled state, and how do you recover it (both manual and automatic)?\n5. Describe a complete documentation and training plan so network staff understand when to use each enhancement (PortFast, BPDU Guard, Root Guard, Loop Guard) and the risks of misuse.\n\n================================================================================\nSCENARIO 4: PATH COST OPTIMIZATION AND LOAD BALANCING\n================================================================================\nMeridian has five access layer switches (ASW1-ASW5) and two distribution layer switches (DSW1, DSW2) forming a redundant topology. Each ASW has two 1 Gbps uplinks: one to DSW1 and one to DSW2. Both DSW1 and DSW2 are 10 Gbps connected to each other (4 links).\n\nCurrent Issue:\nAll traffic from access layer flows through DSW1 (root bridge). DSW2 sits idle. The customer's high-capacity links on DSW2 are underutilized.\n\nDesired Outcome:\nLoad balance traffic across both distribution switches. Sales (VLAN 10) uses DSW1 path, Engineering (VLAN 20) uses DSW2 path.\n\nNetwork Details:\n- ASW1-5 uplinks: 1 Gbps each (802.1w cost 20,000)\n- DSW1-DSW2 core links: 10 Gbps each (802.1w cost 2,000)\n- DSW1 is currently root bridge for all VLANs\n\nQUESTIONS:\n1. Explain why all traffic currently flows through DSW1 even though DSW2 has identical 1 Gbps uplink speeds. What STP metric causes this?\n2. To make Engineering traffic (VLAN 20) prefer DSW2, should you lower the port cost on DSW2 uplinks or lower the bridge priority for VLAN 20? Justify your answer.\n3. Write MSTP configuration commands to:\n   a. Create instance 1 for VLAN 10 (Sales) with DSW1 as root\n   b. Create instance 2 for VLAN 20 (Engineering) with DSW2 as root\n   c. Verify both instances are running and load-balanced\n4. Calculate the root path cost for ASW3 to reach DSW1 root via a 1 Gbps uplink (assume direct connection through one DSW). Show the formula.\n5. After implementing load balancing, which show commands prove that VLANs 10 and 20 are using different root bridges and different distribution switches?\n\n================================================================================\nSCENARIO 5: TROUBLESHOOTING STP CONVERGENCE AND UNIDIRECTIONAL LINKS\n================================================================================\nA branch office has three switches (SW-BRANCH-1, SW-BRANCH-2, SW-BRANCH-3) with redundant links forming a triangle. Yesterday, SW-BRANCH-1 was manually configured as root bridge. Since then, intermittent connectivity issues occur every 15-20 minutes:\n- Some VLANs become unreachable for 10-15 seconds\n- Other VLANs stay up\n- No error messages or BPDU Guard violations\n- STP is in classic 802.1D mode (not RSTP)\n\nWhen the IT manager inspected the fiber optic connections, they discovered that the link between SW-BRANCH-1 and SW-BRANCH-2 has a bad transmit (TX) laser on SW-BRANCH-2. SW-BRANCH-2 can receive traffic from SW-BRANCH-1 (RX is good) but cannot send traffic back to SW-BRANCH-1.\n\nQUESTIONS:\n1. What is a unidirectional link failure, and why does it create STP convergence problems instead of simple packet loss?\n2. Describe what happens in the STP topology when SW-BRANCH-2 stops sending BPDUs but continues receiving them. Which port transitions incorrectly, and what is the result?\n3. Which STP enhancement feature (from Lesson 016) is specifically designed to detect and prevent this problem? How does it work?\n4. Write the CLI commands to enable this feature globally on all point-to-point links and explain why it would have prevented the 15-minute intervals of connectivity loss.\n5. After enabling the enhancement, what show commands would you use to verify the feature is active and to confirm the previously failing port is now detected as problematic?\n\n================================================================================\nSCENARIO 6: BRIDGE ID CALCULATION AND PRIORITY OVERRIDE\n================================================================================\nMeridian has two identical Catalyst 3850 switches in a new office:\n- Switch A: IP 192.168.1.10, MAC 0001.0c9f.f100\n- Switch B: IP 192.168.1.11, MAC 0001.0c9f.f200\n\nBoth are configured with default priority 32768 and default STP mode (PVST+). They are connected via a single 1 Gbps trunk with multiple VLANs (1, 10, 20, 30).\n\nNetwork Requirements:\n1. Switch A must be root bridge for VLAN 1 (management)\n2. Switch A must be root bridge for VLANs 10 and 20 (primary business)\n3. Switch B must be root bridge for VLAN 30 (development, lower priority)\n\nQUESTIONS:\n1. Calculate the Bridge ID for both switches for VLAN 1 (Priority + Extended System ID + MAC). Which switch would become root bridge using default priority? Show your calculation.\n2. To force Switch A as root for VLAN 1, what priority value should you configure? Explain why you chose that value (hint: priority must be multiple of 4096).\n3. To force Switch B as root for VLAN 30 while keeping Switch A as root for VLANs 1, 10, 20, what are the minimum priority changes needed on each switch for each VLAN?\n4. Write the complete CLI commands for Switch A to make it root for VLANs 1, 10, and 20 using the root bridge macro method.\n5. Write the complete CLI commands for Switch B to make it root for VLAN 30 using explicit priority configuration.\n6. Verify the configuration with show commands that prove each VLAN has the correct root bridge.\n\n================================================================================\nEND OF EXERCISE\n================================================================================",
  "solution": "# Spanning Tree Protocol Lab - Complete Solutions\n# Each scenario answers the questions with professional STP knowledge and CLI detail.\n\n================================================================================\nSCENARIO 1: ROOT BRIDGE ELECTION AND PORT ROLE ASSIGNMENT - SOLUTION\n================================================================================\n1. Bridge ID Calculation (Default Priority 32768):\n   SW1 Bridge ID: 32768 + 0000.0c9f.f001 = 32768.0000.0c9f.f001\n   SW2 Bridge ID: 32768 + 0000.0c9f.f002 = 32768.0000.0c9f.f002\n   SW3 Bridge ID: 32768 + 0000.0c9f.f003 = 32768.0000.0c9f.f003\n   \n   Root Bridge Election:\n   - All priorities are identical (32768)\n   - Lowest MAC address wins: 0000.0c9f.f001 (SW1)\n   - Therefore, SW1 became the root bridge by default\n\n2. Port Role Assignment (assuming SW1 set to priority 0):\n   \n   SW1 (Root Bridge - Priority 0):\n   - All ports become Designated Ports (DP)\n   - All ports in Forwarding state\n   - No Root Port (only root bridge has no root port)\n   \n   SW2 (Non-Root Switch):\n   - Root Port: The port with lowest root path cost to SW1\n     - If SW2-SW1 link exists with cost 4, that is the root port\n     - Root path cost = 4 (single 1 Gbps link to root)\n   - Designated Ports: Ports toward access switches or other branches\n   - Blocked/Alternate Port: One of the two SW2-SW3 links (blocked to prevent loop)\n     - Root path cost via this link = 4 + 4 + 4 = 12 (through SW3 to SW1)\n     - Higher than direct path (4), so blocked\n   \n   SW3 (Non-Root Switch):\n   - Root Port: Whichever SW3-SW1 or SW3-SW2 link has lowest root path cost\n     - If direct SW3-SW1 link exists: cost = 4 (root port)\n     - Alternate: SW3-SW2 link: cost = 4 + 4 = 8 (blocked)\n   - Designated Ports: Other ports\n   \n   Port Role Selection Criteria (in order):\n   1. Lowest Root Path Cost (sum of all port costs to root)\n   2. Lowest Sender Bridge ID (of the switch sending the best BPDU)\n   3. Lowest Sender Port ID (of the port sending the BPDU)\n\n3. Show Commands for Verification:\n   \n   Show which switch is root:\n   SW1# show spanning-tree root\n   SW1# show spanning-tree vlan 1\n   (Output shows: Root ID Priority 0, Address 0000.0c9f.f001)\n   \n   Show root port on non-root switches:\n   SW2# show spanning-tree\n   (Output shows which port is Root Port, marked with role RP)\n   \n   Show all port roles and states:\n   SW2# show spanning-tree interface\n   (Output shows: Role Sts for each port)\n   \n   Detailed verification:\n   SW2# show spanning-tree detail\n\n4. Root Path Cost Calculation for SW3 to SW1:\n   \n   Path A (Direct SW3-SW1 link):\n   - 1 Gbps link cost = 4 (using 802.1w costs)\n   - Root path cost = 4\n   \n   Path B (Via SW2: SW3-SW2 then SW2-SW1):\n   - SW3-SW2 link (1 Gbps): cost 4\n   - SW2-SW1 link (1 Gbps): cost 4\n   - Root path cost = 4 + 4 = 8\n   \n   Decision: STP prefers Path A (cost 4 < 8)\n   - SW3 root port: Direct SW3-SW1 link (forwarding)\n   - SW3 alternate port: SW3-SW2 link (blocked)\n\n5. CLI Commands to Configure SW1 as Root:\n   \n   Method 1: Manual Priority Configuration\n   SW1(config)# spanning-tree vlan 1 priority 0\n   (Priority must be multiple of 4096: 0, 4096, 8192, ..., 61440)\n   \n   Method 2: Root Bridge Macro\n   SW1(config)# spanning-tree vlan 1 root primary\n   (Automatically sets priority to 24576, makes SW1 root)\n   \n   Verify Configuration:\n   SW1# show spanning-tree root\n   SW1# show spanning-tree priority\n   \n   On SW2 and SW3, verify topology changed:\n   SW2# show spanning-tree\n   (Should show SW1 as root, SW2 has root port pointing to SW1)\n   \n   Verify port cost and role:\n   SW2# show spanning-tree interface gi0/1\n\n================================================================================\nSCENARIO 2: RSTP FAST CONVERGENCE VS. CLASSIC STP DELAYS - SOLUTION\n================================================================================\n1. Classic STP (802.1D) Convergence Timing:\n   \n   When SW1-SW2 link failed, SW3 alternate port transitioned:\n   \n   State Transitions and Timers:\n   - Blocking State (Max Age = 20 seconds): Switch waits to ensure old BPDU is gone\n   - Listening State (Forward Delay = 15 seconds): Switch determines new port roles\n   - Learning State (Forward Delay = 15 seconds): MAC table populated\n   - Forwarding State: Traffic begins\n   \n   Total Convergence Time = 20 + 15 + 15 = 50 seconds\n   \n   The user experienced ~45 seconds because the failure was detected before full Max Age expired.\n   \n   Why So Slow?\n   - Conservative design to ensure all BPDUs stop before transitioning\n   - Prevents temporary loops during topology change\n   - Unacceptable for modern networks with critical services\n\n2. RSTP (Rapid PVST+) Fast Convergence:\n   \n   RSTP Convergence Time: 1-2 seconds (vs 50 seconds for STP)\n   \n   Proposal/Agreement Mechanism:\n   1. When topology change occurs, downstream switch sends Proposal BPDU\n   2. Upstream switch blocks all non-edge ports (proposal phase)\n   3. Upstream switch sends Agreement BPDU back\n   4. Downstream switch immediately transitions to forwarding (sub-second)\n   5. Edge ports bypass proposal/agreement and forward immediately\n   \n   RSTP State Reductions:\n   - Discarding: Equivalent to Disabled, Blocking, Listening\n   - Learning: Same as 802.1D\n   - Forwarding: Same as 802.1D\n   \n   Result: Only 2 states instead of 5, plus proposal/agreement = fast convergence\n\n3. PortFast and BPDU Guard Benefits:\n   \n   PortFast:\n   - Enabled on access ports (PCs, servers, printers)\n   - Port transitions immediately to forwarding (no state delays)\n   - Eliminates 30-50 second wait for end devices to connect\n   - DHCP clients receive IPs without timeout\n   - Users experience instant connectivity\n   \n   BPDU Guard:\n   - If BPDU received on PortFast port, err-disable the port immediately\n   - Prevents rogue switches from connecting to access ports\n   - Detects user mistakes (connecting switch to access port)\n   - Would have prevented the contractor's switch loop in Scenario 3\n\n4. CLI Commands to Upgrade to RSTP on All Three Switches:\n   \n   On SW1, SW2, and SW3:\n   \n   Enable RSTP globally:\n   SW1(config)# spanning-tree mode rapid-pvst\n   (Changes from PVST to Rapid-PVST+)\n   \n   Verify change:\n   SW1# show spanning-tree summary\n   (Output: Switch is in rapid-pvst mode)\n   \n   Enable PortFast globally on all access ports:\n   SW1(config)# spanning-tree portfast default\n   (Enables PortFast on all non-trunking ports)\n   \n   Verify PortFast:\n   SW1# show spanning-tree summary\n   SW1# show interfaces status\n\n5. RSTP Feature That Enables Instant Connection:\n   \n   Feature: Edge Port (PortFast)\n   \n   How it works:\n   - When PortFast is enabled, port assumes it connects to end device\n   - Port bypasses proposal/agreement and state transitions\n   - Port goes directly to forwarding (no delay)\n   - User workstation connects immediately\n   \n   Risk of PortFast on Switch-to-Switch Link:\n   - If PortFast enabled on trunk between two switches and BPDU Guard not enabled:\n     - Both switch ports go directly to forwarding\n     - Creates immediate bridging loop\n     - Broadcast storms occur instantly\n     - No STP blocking to prevent loop\n   \n   Always Combine:\n   - PortFast + BPDU Guard together\n   - If BPDU received on PortFast port, err-disable immediately\n   - Prevents loops from accidental switch-to-switch connections\n\n================================================================================\nSCENARIO 3: STP ENHANCEMENTS - PORTFAST, BPDU GUARD, AND ROOT GUARD - SOLUTION\n================================================================================\n1. How PortFast Loop Created Broadcast Storms:\n   \n   Problem:\n   - With global PortFast enabled, both SW1 and SW2 access ports going to forwarding immediately\n   - No STP port roles assigned (both think they're connected to end devices)\n   - When cable connected between access ports, both ports start forwarding\n   - Broadcast frames loop between the two ports forever\n   - MAC table thrashing: same MAC appears on both ports continuously\n   - CPU at 100% processing endless loops\n   \n   Why STP Didn't Block Immediately:\n   - PortFast ports bypass BPDU processing\n   - STP didn't detect the loop because BPDU Guard wasn't enabled\n   - Ports were configured as \"Edge Ports\" (end device assumption)\n   - STP only monitors BPDUs between switches, not between edge ports\n   \n   Key Lesson: PortFast creates loops without BPDU Guard protection\n\n2. Why Contractor's Switch Became Root:\n   \n   Scenario:\n   - Contractor's managed switch plugged into access port\n   - Switch advertised Bridge ID with lower priority (default 32768, but lower MAC)\n   - Or it had priority 24576 (lower than default 32768)\n   - Switch immediately became root bridge\n   \n   Why So Fast:\n   - No Root Guard on access ports (Root Guard only on uplinks)\n   - No priority lock preventing lower-priority devices from becoming root\n   - Every switch changed topology to new root\n   - Massive convergence event across entire network\n   \n   Vulnerability Exposed:\n   - Access layer switches can be compromised from user ports\n   - Any managed switch plugged in can hijack network\n   - Classic STP assumes enterprise controls physical layer\n   - Modern networks need additional controls (Root Guard, BPDU Guard)\n\n3. Complete CLI Commands for STP Enhancements:\n   \n   a. BPDU Guard Globally (on all PortFast ports):\n   On SW1, SW2, SW3:\n   SW1(config)# spanning-tree portfast bpduguard default\n   (Enables BPDU Guard on all PortFast ports)\n   \n   b. Configure SW1 as Root with Priority 0:\n   On SW1:\n   SW1(config)# spanning-tree vlan 1 priority 0\n   SW1(config)# spanning-tree vlan 10 priority 0\n   SW1(config)# spanning-tree vlan 20 priority 0\n   SW1(config)# spanning-tree vlan 30 priority 0\n   (Or use: spanning-tree vlan all priority 0)\n   \n   c. Configure Root Guard on Uplink Ports (toward distribution):\n   On SW1, SW2, SW3 for uplink interfaces:\n   SW1(config)# interface GigabitEthernet 0/1\n   SW1(config-if)# spanning-tree guard root\n   \n   d. Enable Loop Guard on Point-to-Point Trunk Links:\n   On all switches for switch-to-switch trunks:\n   SW1(config)# spanning-tree loopguard default\n   (Enables globally on all point-to-point links)\n   \n   Or per-interface:\n   SW1(config)# interface GigabitEthernet 0/2\n   SW1(config-if)# spanning-tree guard loop\n\n4. Err-Disabled State and Recovery:\n   \n   How BPDU Guard Err-Disables Ports:\n   - Access port with PortFast enabled receives BPDU\n   - BPDU Guard immediately disables port (err-disabled state)\n   - Port goes down, user loses connectivity\n   - Prevents broadcast storm from the accidental switch connection\n   \n   Manual Recovery:\n   SW1# configure terminal\n   SW1(config)# interface GigabitEthernet 0/10\n   SW1(config-if)# shutdown\n   SW1(config-if)# no shutdown\n   (Port returns to normal state)\n   \n   Automatic Recovery (Recommended):\n   SW1(config)# errdisable recovery cause bpduguard\n   SW1(config)# errdisable recovery interval 300\n   (Port automatically recovers after 300 seconds/5 minutes)\n   \n   Verify Err-Disabled Ports:\n   SW1# show interfaces status err-disabled\n   (Shows all err-disabled ports and reasons)\n\n5. Documentation and Training Plan:\n   \n   STP Enhancement Decision Tree:\n   \n   PortFast:\n   - When: Access ports connected ONLY to end devices (PC, server, printer)\n   - Why: Eliminates 30-50 second STP delay for DHCP, PXE boot, user experience\n   - Risk: If enabled on switch-to-switch link, creates immediate loop\n   - Always combine with: BPDU Guard\n   - Do NOT use on: Trunk ports, switch-to-switch links, WAP management ports\n   \n   BPDU Guard:\n   - When: Always enable on all PortFast ports (global setting)\n   - Why: Detects and prevents rogue switches from connecting to access ports\n   - How: Err-disables port if BPDU received (user error detection)\n   - Recovery: Manual (shut/no shut) or automatic (errdisable recovery)\n   - Risk: May disable legitimate devices (e.g., managed devices on access port)\n   \n   Root Guard:\n   - When: All uplinks from access to distribution layer switches\n   - Why: Prevents downstream switches from becoming root bridge\n   - How: Blocks port if superior BPDU received from downstream\n   - Result: Maintains hierarchical spanning tree topology\n   - Use case: Large networks with multiple layers\n   \n   Loop Guard:\n   - When: All point-to-point trunk links (switch-to-switch)\n   - Why: Detects unidirectional link failures (broken TX laser, cable issue)\n   - How: Blocks port if BPDU stops arriving (link failure detected)\n   - Prevention: Prevents alternate port from becoming designated when BPDUs stop\n   - Use case: Detects one-way link failures that normal STP misses\n   \n   User Training:\n   - NEVER enable PortFast on switch-to-switch links\n   - ALWAYS enable BPDU Guard with PortFast\n   - Report err-disabled access ports to network team (indicates problem)\n   - Don't connect your own switch to office network\n   - If connecting new device, verify with IT first\n   \n   Network Team Training:\n   - Document all access ports with PortFast enabled\n   - Monitor err-disabled ports (alerts for user mistakes)\n   - Implement automatic errdisable recovery\n   - Test STP topology monthly\n   - Verify root bridge location quarterly\n\n================================================================================\nSCENARIO 4: PATH COST OPTIMIZATION AND LOAD BALANCING - SOLUTION\n================================================================================\n1. Why All Traffic Flows Through DSW1:\n   \n   Root Bridge Election:\n   - DSW1 was configured as root bridge (lowest priority)\n   - All ASW switches use DSW1 as root\n   - All ASW root ports point to DSW1\n   - All ASW uplink traffic flows to DSW1\n   \n   Even though DSW2 has identical 1 Gbps uplinks:\n   - Path cost via DSW1: 20,000 (direct 1 Gbps uplink)\n   - Path cost via DSW2: 20,000 + 20,000 + 2,000 = 42,000\n     (ASW to DSW2 = 20,000, DSW2 to DSW1 = 20,000, but also core links = 2,000)\n   - Wait, let me recalculate:\n   - Path via DSW2 to reach DSW1 root: ASW-DSW2 (20,000) + DSW2-DSW1 core (2,000 + 2,000...) \n   - Actually, DSW2 has 4 x 10 Gbps core links. Let's assume parallel links.\n   - Regardless, DSW1 is root, so all traffic prefers DSW1\n   \n   The Issue:\n   - DSW2 becomes all alternate/blocked ports\n   - Root path cost favors DSW1 (root bridge)\n   - DSW2 capacity wasted\n\n2. Should Lower Port Cost or Bridge Priority:\n   \n   Answer: Lower bridge priority (create second root bridge with MSTP)\n   \n   Why Not Lowering Port Cost:\n   - Lowering DSW2 port cost makes DSW2 designated port (not root port)\n   - ASWs would still prefer DSW1 root bridge\n   - Port cost only affects local switch decisions, not root bridge selection\n   \n   Correct Approach: MSTP (Multiple Spanning Tree Protocol)\n   - Create instance 1 with DSW1 as root\n   - Create instance 2 with DSW2 as root\n   - Map VLAN 10 to instance 1 (uses DSW1 path)\n   - Map VLAN 20 to instance 2 (uses DSW2 path)\n   - Different root bridges per VLAN = load balanced traffic\n\n3. MSTP Configuration Commands:\n   \n   On All Switches (DSW1, DSW2, ASW1-ASW5):\n   \n   Enter MSTP configuration:\n   Switch(config)# spanning-tree mode mst\n   Switch(config)# spanning-tree mst configuration\n   \n   Set region parameters (must match all switches):\n   Switch(config-mst)# name MERIDIAN-NETWORK\n   Switch(config-mst)# revision 1\n   \n   Map VLANs to instances:\n   Switch(config-mst)# instance 1 vlan 10\n   Switch(config-mst)# instance 2 vlan 20\n   Switch(config-mst)# exit\n   \n   Configure root bridge for instance 1 (DSW1):\n   DSW1(config)# spanning-tree mst 1 priority 4096\n   \n   Configure root bridge for instance 2 (DSW2):\n   DSW2(config)# spanning-tree mst 2 priority 4096\n   \n   Set secondary root on other switches:\n   DSW2(config)# spanning-tree mst 1 priority 8192\n   DSW1(config)# spanning-tree mst 2 priority 8192\n   \n   Verify MSTP configuration:\n   Switch# show spanning-tree mst configuration\n   Switch# show spanning-tree mst 1\n   Switch# show spanning-tree mst 2\n\n4. Root Path Cost Calculation for ASW3:\n   \n   Scenario: ASW3 to DSW1 root via 1 Gbps uplink (direct connection)\n   \n   Formula: Root Path Cost = Sum of all port costs from switch to root\n   \n   Path: ASW3 → DSW1 (1 Gbps uplink)\n   - ASW3 uplink cost = 20,000 (802.1w cost for 1 Gbps)\n   - Total root path cost = 20,000\n   \n   Alternative path (if direct link down): ASW3 → ASW4 → DSW1\n   - ASW3 to ASW4 cost = 20,000 (1 Gbps)\n   - ASW4 to DSW1 cost = 20,000 (1 Gbps)\n   - Total = 40,000 (higher cost, not preferred)\n   \n   STP Decision:\n   - Lowest cost path wins\n   - ASW3 root port = direct DSW1 uplink (cost 20,000)\n   - Alternate path through ASW4 is blocked\n\n5. Show Commands Verifying Load Balancing:\n   \n   Verify both instances are running:\n   DSW1# show spanning-tree mst summary\n   (Output shows Instance 0, Instance 1, Instance 2)\n   \n   Show root bridge for instance 1:\n   DSW1# show spanning-tree mst 1\n   (Output: Root ID shows DSW1 as root for instance 1)\n   \n   Show root bridge for instance 2:\n   DSW2# show spanning-tree mst 2\n   (Output: Root ID shows DSW2 as root for instance 2)\n   \n   Verify ASW uplinks are load balanced:\n   ASW1# show spanning-tree mst 1\n   (Output: Instance 1 shows root port toward DSW1)\n   \n   ASW1# show spanning-tree mst 2\n   (Output: Instance 2 shows root port toward DSW2)\n   \n   On ASW1, instance 1 traffic uses DSW1 path, instance 2 traffic uses DSW2 path\n   Result: Load balanced across both distribution switches\n\n================================================================================\nSCENARIO 5: TROUBLESHOOTING STP CONVERGENCE AND UNIDIRECTIONAL LINKS - SOLUTION\n================================================================================\n1. Unidirectional Link Failure Definition:\n   \n   What is it:\n   - Link where one direction works (TX good, RX works) but other direction fails (TX bad, RX fails)\n   - Switch A can send to Switch B (TX A works, RX B works)\n   - Switch B CANNOT send to Switch A (TX B broken, RX A fails)\n   - One-way communication path\n   \n   Example (Fiber optic laser failure):\n   - SW-BRANCH-2 TX laser failed (cannot transmit)\n   - SW-BRANCH-2 RX still works (can receive from other switches)\n   - SW-BRANCH-1 can send to SW-BRANCH-2 (traffic flows one way)\n   - SW-BRANCH-2 cannot send back to SW-BRANCH-1 (traffic blocked)\n   \n   Why STP Convergence Problem:\n   - STP relies on BPDUs (Bridge Protocol Data Units) for topology learning\n   - If BPDUs stop arriving from one direction, STP can't detect the unidirectional link\n   - Port receiving data but not BPDUs may transition to inappropriate role\n   - Temporary loops and blackholes occur\n   - Traffic gets lost, causing 15-second outages (until alternate path found)\n\n2. STP Topology Behavior During Unidirectional Failure:\n   \n   Scenario: SW-BRANCH-2 TX laser failed\n   \n   What Happens:\n   - SW-BRANCH-2 still receives BPDUs from SW-BRANCH-1\n   - SW-BRANCH-1 STOPS receiving BPDUs from SW-BRANCH-2\n   - SW-BRANCH-1 thinks link is down (BPDUs stopped)\n   - SW-BRANCH-2 still thinks link is up (BPDUs arriving)\n   - Asymmetry in topology awareness\n   \n   Port Role Confusion:\n   - On SW-BRANCH-1: Port stops receiving BPDUs → thinks link is down → transitions\n   - On SW-BRANCH-2: Port still receives BPDUs → thinks link is up → stays forwarding\n   - SW-BRANCH-1 may transition alternate port to forwarding (seeks new path)\n   - Temporary loop: SW-BRANCH-2 still sending on failed link, SW-BRANCH-1 trying new path\n   - Traffic gets dropped or delayed (15 second interval = Max Age timer)\n   \n   Result: 15-20 minute intervals of 10-15 second outages\n   - Classic STP's Max Age timer (20 seconds) detects link is really down\n   - Convergence takes full STP timers (50 seconds)\n   - Every 15-20 minutes, enough time passes to trigger convergence cycle\n   - Causes intermittent connectivity problems\n\n3. STP Enhancement for Unidirectional Link Detection:\n   \n   Feature: Loop Guard (802.1w feature, also in RSTP)\n   \n   What Loop Guard Does:\n   - Monitors BPDU arrival on point-to-point links\n   - If BPDUs stop arriving, puts port in \"loop-inconsistent\" state\n   - Blocks port until BPDUs resume\n   - Prevents alternate/root ports from becoming designated when BPDUs stop\n   \n   How It Prevents Problem:\n   - SW-BRANCH-1 enables Loop Guard on link to SW-BRANCH-2\n   - When TX laser fails, SW-BRANCH-1 stops receiving BPDUs\n   - Loop Guard immediately puts port in loop-inconsistent state (blocks it)\n   - SW-BRANCH-1 uses alternate path through SW-BRANCH-3\n   - No temporary loop, no 15-second outages\n   - Traffic quickly reroutes through working links\n\n4. CLI Commands to Enable Loop Guard:\n   \n   Global Enable (all point-to-point links):\n   SW-BRANCH-1(config)# spanning-tree loopguard default\n   SW-BRANCH-2(config)# spanning-tree loopguard default\n   SW-BRANCH-3(config)# spanning-tree loopguard default\n   \n   Per-Interface Enable:\n   SW-BRANCH-1(config)# interface GigabitEthernet 0/1\n   SW-BRANCH-1(config-if)# spanning-tree guard loop\n   (Repeat for all switch-to-switch links)\n   \n   Why It Prevents Problem:\n   - Loop Guard detects unidirectional link failures immediately\n   - Blocks port before STP convergence (faster detection)\n   - Alternate path through SW-BRANCH-3 becomes active\n   - No temporary loops, no 15-second outages\n   - Clean failover to working links\n\n5. Show Commands to Verify Loop Guard and Problem Detection:\n   \n   Verify Loop Guard is enabled:\n   SW-BRANCH-1# show spanning-tree summary\n   (Output: Loopguard Default is enabled)\n   \n   Check for loop-inconsistent ports (detected problems):\n   SW-BRANCH-1# show spanning-tree inconsistentports\n   (Output: Shows ports in loop-inconsistent state)\n   \n   Detailed interface information:\n   SW-BRANCH-1# show spanning-tree interface GigabitEthernet 0/1 detail\n   (Output: Shows Loop Guard status, port state, BPDU info)\n   \n   Monitor topology changes:\n   SW-BRANCH-1# show spanning-tree summary totals\n   (Output: Topology Change Count - shows how many detected)\n   \n   Check BPDU reception on specific port:\n   SW-BRANCH-1# debug spanning-tree bpdu detail\n   (Shows BPDUs arriving on each interface - will stop if link fails)\n   \n   After Fixing Link (laser replaced):\n   - Loop Guard stops blocking port\n   - Port transitions back through normal STP states\n   - Connectivity restored\n   - No more intermittent outages\n\n================================================================================\nSCENARIO 6: BRIDGE ID CALCULATION AND PRIORITY OVERRIDE - SOLUTION\n================================================================================\n1. Bridge ID Calculation for VLAN 1 (Default Priority 32768):\n   \n   Bridge ID Formula: Priority (16 bits) + Extended System ID (12 bits) + MAC Address (48 bits)\n   \n   Switch A Bridge ID for VLAN 1:\n   - Priority: 32768\n   - Extended System ID: VLAN 1 = 0001 (4 bits, in 12-bit field)\n   - MAC Address: 0001.0c9f.f100\n   - Full Bridge ID: 32768:0001.0c9f.f100\n   (Or written as: 32769.0001.0c9f.f100 in many tools)\n   \n   Switch B Bridge ID for VLAN 1:\n   - Priority: 32768\n   - Extended System ID: VLAN 1 = 0001\n   - MAC Address: 0001.0c9f.f200\n   - Full Bridge ID: 32768:0001.0c9f.f200\n   (Or written as: 32769.0001.0c9f.f200)\n   \n   Root Bridge Election (Using Default Priority):\n   - Priorities are equal (both 32768 + VLAN ID 1 = 32769)\n   - Lowest MAC address wins: 0001.0c9f.f100 (Switch A)\n   - Therefore: Switch A becomes root bridge for VLAN 1 by default\n   \n   This happens to match requirement #1, but should be explicitly configured\n\n2. Priority Configuration to Force Switch A as Root for VLAN 1:\n   \n   Current Bridge ID: 32768:0001.0c9f.f100\n   Target: Make Switch A root with lower priority than Switch B\n   \n   Priority Values (must be multiples of 4096):\n   - 0 (lowest possible) ← Best for root bridge\n   - 4096\n   - 8192\n   - 12288\n   - 16384\n   - 20480\n   - 24576\n   - 28672\n   - 32768 (default)\n   - ... up to 61440 (highest)\n   \n   Configure Switch A as Root:\n   Switch-A(config)# spanning-tree vlan 1 priority 0\n   \n   New Bridge ID for Switch A VLAN 1: 0:0001.0c9f.f100\n   \n   This is guaranteed to be lowest Bridge ID (priority 0 is minimum)\n   Switch B remains at 32768:0001.0c9f.f200\n   Result: Switch A becomes root, Switch B as backup\n   \n   Why Priority 0:\n   - Absolutely lowest possible priority\n   - No other switch can have lower priority\n   - Guarantees this switch is root\n   - Industry standard for root bridge\n   - Makes intent clear to network team\n\n3. Minimum Priority Changes for Each VLAN:\n   \n   Requirements Summary:\n   - VLAN 1: Switch A root (with priority 0)\n   - VLAN 10: Switch A root\n   - VLAN 20: Switch A root\n   - VLAN 30: Switch B root\n   \n   Current State (all at default 32768):\n   - All VLANs would use MAC tiebreaker\n   - VLAN 1,10,20,30: Switch A (lower MAC 0001.0c9f.f100)\n   - This matches requirements for VLANs 1,10,20 but VLAN 30 should use Switch B\n   \n   Configuration Strategy:\n   \n   Switch A:\n   - Set priority 0 for VLANs 1, 10, 20 (root for these)\n   - Set priority 8192 for VLAN 30 (secondary, not root)\n   \n   Switch B:\n   - Set priority 4096 for VLAN 30 (root for this VLAN)\n   - Set priority 8192 for VLANs 1,10,20 (backup, not root)\n   \n   Minimum Priority Values:\n   - Switch A VLAN 1: 0 (ensure root)\n   - Switch A VLAN 10: 0 (ensure root)\n   - Switch A VLAN 20: 0 (ensure root)\n   - Switch A VLAN 30: 8192 (ensure Switch B is root)\n   - Switch B VLAN 30: 4096 (primary root for this VLAN)\n   - Switch B VLAN 1,10,20: 8192 (backup, not primary)\n   \n   Result: Separate root bridge for each business unit while maintaining hierarchy\n\n4. Complete CLI Commands for Switch A:\n   \n   Configure Switch A as root for VLANs 1, 10, 20:\n   \n   Method 1: Using root bridge macro (automatic priority 24576)\n   Switch-A(config)# spanning-tree vlan 1 root primary\n   Switch-A(config)# spanning-tree vlan 10 root primary\n   Switch-A(config)# spanning-tree vlan 20 root primary\n   (Automatically sets priority to 24576, makes Switch A root)\n   \n   Method 2: Using explicit priority 0 (better for explicit control)\n   Switch-A(config)# spanning-tree vlan 1 priority 0\n   Switch-A(config)# spanning-tree vlan 10 priority 0\n   Switch-A(config)# spanning-tree vlan 20 priority 0\n   \n   Ensure Switch A is NOT root for VLAN 30 (set to secondary):\n   Switch-A(config)# spanning-tree vlan 30 priority 8192\n   \n   Verify configuration:\n   Switch-A# show spanning-tree priority\n   Switch-A# show spanning-tree root\n\n5. Complete CLI Commands for Switch B:\n   \n   Configure Switch B as root for VLAN 30:\n   \n   Method 1: Using root bridge macro\n   Switch-B(config)# spanning-tree vlan 30 root primary\n   (Sets priority to 24576 for VLAN 30)\n   \n   Method 2: Using explicit priority 4096 (lower than default 32768)\n   Switch-B(config)# spanning-tree vlan 30 priority 4096\n   (Explicitly set to 4096 to beat Switch A's 8192 for VLAN 30)\n   \n   Set Switch B as secondary (backup) for VLANs 1, 10, 20:\n   Switch-B(config)# spanning-tree vlan 1 priority 8192\n   Switch-B(config)# spanning-tree vlan 10 priority 8192\n   Switch-B(config)# spanning-tree vlan 20 priority 8192\n   \n   Verify configuration:\n   Switch-B# show spanning-tree priority\n   Switch-B# show spanning-tree root\n\n6. Verification Commands Proving Correct Root Bridge per VLAN:\n   \n   On Switch A:\n   Switch-A# show spanning-tree root\n   (Output shows:\n    - VLAN1:   Root Priority 0, Address 0001.0c9f.f100 (This bridge is root)\n    - VLAN10:  Root Priority 0, Address 0001.0c9f.f100 (This bridge is root)\n    - VLAN20:  Root Priority 0, Address 0001.0c9f.f100 (This bridge is root)\n    - VLAN30:  Root Priority 4096, Address 0001.0c9f.f200 (via port GigabitEthernet0/1))\n   \n   On Switch B:\n   Switch-B# show spanning-tree root\n   (Output shows:\n    - VLAN1:   Root Priority 0, Address 0001.0c9f.f100 (via port GigabitEthernet0/1)\n    - VLAN10:  Root Priority 0, Address 0001.0c9f.f100 (via port GigabitEthernet0/1)\n    - VLAN20:  Root Priority 0, Address 0001.0c9f.f100 (via port GigabitEthernet0/1)\n    - VLAN30:  Root Priority 4096, Address 0001.0c9f.f200 (This bridge is root))\n   \n   Detailed verification by VLAN:\n   Switch-A# show spanning-tree vlan 1\n   (Shows all details for VLAN 1: root info, port roles, timers)\n   \n   Switch-A# show spanning-tree vlan 30\n   (Shows VLAN 30: Switch A is NOT root, path to Switch B)\n   \n   Switch-B# show spanning-tree vlan 30\n   (Shows VLAN 30: Switch B IS root)\n   \n   Priority verification:\n   Switch-A# show spanning-tree priority\n   (Shows VLAN priorities configured)\n   \n   All VLANs Summary:\n   Switch-A# show spanning-tree summary\n   (Shows STP mode, root bridge for all VLANs)\n\n================================================================================\nEND OF SOLUTIONS\n================================================================================",
  "hints": [
    "Bridge ID = Priority + Extended System ID + MAC Address. Lowest Bridge ID becomes root bridge. Priority is compared first (lower wins), then MAC address (lower wins) as tiebreaker.",
    "Always manually configure the root bridge by setting priority to 0 or using the root bridge macro. Don't rely on default election based on MAC address.",
    "Classic STP (802.1D) takes 50 seconds to converge (Max Age 20s + Forward Delay 15s + Forward Delay 15s). RSTP converges in 1-2 seconds using proposal/agreement.",
    "PortFast must ALWAYS be combined with BPDU Guard. PortFast alone on switch-to-switch links creates immediate loops. BPDU Guard err-disables the port if a BPDU arrives.",
    "Root Port is selected based on: 1) Lowest root path cost, 2) Lowest sender Bridge ID, 3) Lowest sender port ID. Designated Ports send best BPDU on each segment.",
    "Root Path Cost = sum of all port costs from switch to root bridge. Use 802.1w costs (1 Gbps = 20,000, 10 Gbps = 2,000) unless running classic STP (1 Gbps = 4).",
    "Loop Guard detects unidirectional link failures by monitoring BPDU arrival. If BPDUs stop, port goes to loop-inconsistent state (blocked). Always enable on point-to-point links.",
    "Root Guard prevents downstream switches from becoming root bridge. Always enable on uplinks from access to distribution layer. Port goes to root-inconsistent if superior BPDU received.",
    "MSTP allows different VLANs to have different root bridges. Map VLANs to instances and configure different priorities to load-balance traffic across redundant paths.",
    "Priority must be multiple of 4096 (0, 4096, 8192, ..., 61440). Use 0 for root bridge, 4096 for primary backup, 8192 for secondary backup.",
    "show spanning-tree root shows which switch is root for each VLAN. show spanning-tree shows all port roles and states. show spanning-tree inconsistentports shows ports with problems.",
    "Verify RSTP convergence with show spanning-tree summary (rapid-pvst mode). Verify MSTP instances with show spanning-tree mst configuration and show spanning-tree mst 1/2.",
    "Enable PortFast on access ports only (ends devices like PCs). Enable RSTP globally on all switches. Enable BPDU Guard, Root Guard, and Loop Guard for production networks.",
    "After enabling BPDU Guard, monitor show interfaces status err-disabled for access ports. If port goes err-disabled, investigate why BPDU was received on access port.",
    "Document STP design: which switch is root, expected blocked ports, port costs, and verification commands. Test failover scenarios to ensure alternate paths work correctly."
  ],
  "testCases": [
    {
      "id": "tc1",
      "description": "Confirms understanding of Bridge ID and root bridge election",
      "validation": "assert 'bridge id' in code.lower() and ('priority' in code.lower() or 'mac' in code.lower())",
      "isHidden": false
    },
    {
      "id": "tc2",
      "description": "Ensures port roles (root port, designated, alternate/blocked) are explained",
      "validation": "assert 'root port' in code.lower() and 'designated' in code.lower()",
      "isHidden": false
    },
    {
      "id": "tc3",
      "description": "Verifies RSTP and convergence time discussion",
      "validation": "assert 'rstp' in code.lower() or 'rapid' in code.lower() or 'convergence' in code.lower()",
      "isHidden": false
    },
    {
      "id": "tc4",
      "description": "Checks PortFast and BPDU Guard explanation",
      "validation": "assert 'portfast' in code.lower() and 'bpdu guard' in code.lower()",
      "isHidden": false
    },
    {
      "id": "tc5",
      "description": "Ensures root path cost calculation is present",
      "validation": "assert 'root path cost' in code.lower() or 'path cost' in code.lower()",
      "isHidden": false
    },
    {
      "id": "tc6",
      "description": "Verifies MSTP (Multiple Spanning Tree) configuration",
      "validation": "assert 'mstp' in code.lower() or 'multiple spanning tree' in code.lower() or 'instance' in code.lower()",
      "isHidden": false
    },
    {
      "id": "tc7",
      "description": "Checks loop guard for unidirectional link detection",
      "validation": "assert 'loop guard' in code.lower() or 'unidirectional' in code.lower()",
      "isHidden": false
    },
    {
      "id": "tc8",
      "description": "Ensures Root Guard explanation for preventing root bridge hijacking",
      "validation": "assert 'root guard' in code.lower()",
      "isHidden": false
    },
    {
      "id": "tc9",
      "description": "Verifies show commands for STP verification (show spanning-tree)",
      "validation": "assert 'show spanning-tree' in code.lower() or 'show interfaces trunk' in code.lower()",
      "isHidden": false
    },
    {
      "id": "tc10",
      "description": "Checks discussion of STP enhancements in production networks",
      "validation": "assert 'portfast' in code.lower() or 'bpdu guard' in code.lower() or 'root guard' in code.lower()",
      "isHidden": false
    },
    {
      "id": "tc11",
      "description": "Validates understanding of STP convergence problems and solutions",
      "validation": "assert ('broadcast storm' in code.lower() or 'loop' in code.lower()) and ('rstp' in code.lower() or 'portfast' in code.lower())",
      "isHidden": false
    },
    {
      "id": "tc12",
      "description": "Ensures practical CLI commands are provided for configuration",
      "validation": "assert 'spanning-tree' in code.lower() and 'priority' in code.lower()",
      "isHidden": false
    }
  ]
}
