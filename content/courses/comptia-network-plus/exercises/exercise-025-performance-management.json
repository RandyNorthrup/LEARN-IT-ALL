{
  "id": "exercise-025-performance-management",
  "lessonId": "lesson-025-performance-management",
  "title": "Network Performance Management, QoS Design, and Traffic Shaping Troubleshooting",
  "description": "You are implementing comprehensive performance management for Legal Solutions Group. The company's internet connection is frequently congested during peak hours, causing VoIP quality degradation and slow application performance. Your task is to establish accurate performance baselines, design a multi-tier QoS policy that prioritizes critical traffic, implement traffic shaping to conform to ISP contract rates, and validate the solution. You must analyze performance metrics, make capacity decisions based on data, and troubleshoot QoS implementation issues.",
  "difficulty": "advanced",
  "points": 150,
  "language": "cisco-ios",
  "scenario": {
    "company": "Legal Solutions Group",
    "situation": "Internet congestion during 11am-1pm and 3pm-5pm peak hours. VoIP calls dropping, document uploads timing out, email slow. ISP contract 100 Mbps but users experiencing packet loss.",
    "network_details": {
      "internet_interface": "GigabitEthernet0/1 (ISP uplink)",
      "isp_contract_rate": "100 Mbps",
      "internal_network": "1 Gbps backbone (no congestion internally)",
      "applications": {
        "voip": {"codec": "G.711 (64 kbps/call)", "concurrent_calls": "25 simultaneous", "total_bandwidth": "1.6 Mbps typical, 2 Mbps with overhead"},
        "document_management": {"traffic": "Occasional spikes (file uploads/downloads)", "typical_bandwidth": "20-30 Mbps"},
        "email": {"traffic": "Continuous background", "typical_bandwidth": "5-10 Mbps"},
        "web_access": {"traffic": "Browsing, cloud services", "typical_bandwidth": "15-25 Mbps"},
        "enterprise_applications": {"traffic": "Case management, financial software", "typical_bandwidth": "10-15 Mbps"}
      },
      "current_users": "120 attorneys + 80 support staff",
      "office_schedule": "9am-6pm peak, 6pm-9am off-hours"
    },
    "baseline_data_collected": {
      "collection_period": "30 days",
      "average_utilization": "42 Mbps",
      "95th_percentile": "76 Mbps",
      "peak_5min_average": "94 Mbps",
      "peak_spike_1min": "102 Mbps (exceeds ISP contract!)",
      "traffic_trend": "Growing 2.8% per month"
    },
    "business_requirements": [
      "VoIP quality: <150ms latency, <30ms jitter, <1% packet loss",
      "Document uploads: Complete 50MB file in <2 minutes",
      "Email: Deliver within 5 seconds (typical corporate SLA)",
      "Web browsing: Page loads <3 seconds (90th percentile)",
      "Capacity: Support growth for 2+ years before upgrade needed"
    ],
    "current_issues": [
      "Peak utilization (94 Mbps) exceeds available (100 Mbps) with only 6% margin",
      "VoIP calls dropping 2-3% of time during peak hours (unacceptable, should be <0.5%)",
      "File uploads timing out (users perceive as broken)",
      "No differentiation between critical (VoIP, email) and non-critical (YouTube, social media) traffic",
      "Marketing team streaming 4K video during 1pm standup calls",
      "No monitoring of traffic prioritization effectiveness"
    ]
  },
  "starterCode": "# NETWORK PERFORMANCE MANAGEMENT - LEGAL SOLUTIONS GROUP\n# Problem: Internet congestion, VoIP quality issues, slow applications\n# Solution: Establish baseline, implement QoS, configure traffic shaping\n\n# ===================================================================\n# CHALLENGE 1: ANALYZE BASELINE DATA AND MAKE CAPACITY DECISIONS\n# ===================================================================\n# Context: You have 30-day baseline data\n# - Average: 42 Mbps\n# - 95th percentile: 76 Mbps\n# - Peak 5min: 94 Mbps\n# - Peak 1min spike: 102 Mbps (exceeds 100 Mbps contract)\n# - Growth: 2.8% per month\n# - Current users: 200 total\n\n# Challenge 1.1: Baseline analysis\n# Q1: Calculate utilization margin (ISP contract - 95th percentile)\n# Q2: What does \"95th percentile\" mean (why not just use peak or average)?\n# Q3: Why is the 102 Mbps spike concerning (customers don't complain about brief spikes)?\n# Q4: Project utilization for next 12, 24, and 36 months\n# Q5: When should you upgrade ISP (industry recommendation: >70% sustained)?\n# Q6: How much should you upgrade to (options: 150, 200, 300, 500 Mbps)?\n\n# Challenge 1.2: Cost-benefit analysis\n# Current cost: 100 Mbps = $1,500/month = $18,000/year\n# Upgrade option 1: 200 Mbps = $2,200/month (+$700/month = $8,400/year extra)\n# Upgrade option 2: 300 Mbps = $2,800/month (+$1,300/month = $15,600/year extra)\n# Cost of doing nothing if network fails: Firm cannot bill clients = $10,000/day revenue loss\n# Questions:\n# Q7: Calculate break-even: How many days of outage justify the upgrade cost?\n# Q8: What risk are you accepting by staying at 100 Mbps?\n# Q9: Draft email to managing partner with upgrade recommendation\n\n# Challenge 1.3: Who's using the bandwidth?\n# Current peak (94 Mbps):\n# - VoIP: 2 Mbps (known, allocate for 25 calls)\n# - Legitimate business: 30 Mbps (file transfers, email, case management)\n# - Web browsing: 20 Mbps (Google Docs, cloud services, research)\n# - Streaming video: 40 Mbps (YouTube, Netflix, video conference)\n# - P2P/Downloads: 2 Mbps (BitTorrent detected, file sharing)\n# Total: 94 Mbps\n#\n# Questions:\n# Q10: Which 40 Mbps of video is business-critical vs personal?\n# Q11: How would you reduce non-critical bandwidth before upgrading ISP?\n# Q12: What policy would you recommend to CIO (block YouTube vs traffic shape)?\n\n# ===================================================================\n# CHALLENGE 2: DESIGN QoS AND TRAFFIC SHAPING POLICY\n# ===================================================================\n# Goal: Maintain 100 Mbps ISP contract limit while prioritizing business traffic\n\n# Challenge 2.1: Classify traffic into priorities\n# Define 5 traffic classes:\n# 1. CRITICAL (must not lose packets): _________\n# 2. HIGH (prefer delivery): _________\n# 3. MEDIUM (best effort): _________\n# 4. LOW (scavenger): _________\n# 5. DEFAULT (everything else): _________\n#\n# Questions:\n# Q13: What traffic goes in each class (name specific applications)?\n# Q14: Why can't everything be \"CRITICAL\" (what if you do that)?\n# Q15: What DSCP values to use (EF, AF31, AF21, AF11, CS1, BE)?\n\n# Challenge 2.2: Configure traffic shaping policy\n# Remember: 100 Mbps ISP limit, 200 users, peak time 11am-1pm, 3pm-5pm\n#\n# Resource allocation options:\n# Option A: Equal share (everyone gets 100/200 = 500 kbps) - TOO RESTRICTIVE\n# Option B: VoIP gets 5%, documents/email get 50%, web gets 30%, scavenger gets 10%, reserve 5%\n# Option C: No allocation (let router decide) - CAUSES CONGESTION\n# Option D: Dynamic allocation (traffic-dependent) - MOST COMPLEX\n#\n# Design your policy:\n# Shape average: ___________ (in bits/sec)\n# CRITICAL class bandwidth: ___________ Mbps (VoIP must not drop)\n# HIGH class bandwidth: ___________ Mbps (guarantee, non-exceeding)\n# MEDIUM class bandwidth: ___________ Mbps (best effort)\n# LOW class bandwidth: ___________ Mbps (scavenger, can go to 0)\n#\n# Questions:\n# Q16: Why use priority queue for VoIP instead of guaranteed bandwidth?\n# Q17: What's maximum bandwidth you can guarantee to HIGH class (consider ISP overages)?\n# Q18: How do you prevent HIGH class from starving LOW class?\n# Q19: Should you allow classes to borrow unused bandwidth from others? Why/why not?\n\n# Challenge 2.3: Implementation and commands\n# Core-Router-01 GigabitEthernet0/1 (Internet uplink)\n#\n# Step 1: Define class maps (match traffic)\nclass-map match-all VOIP\n  match ip dscp ef                 ! VOIP = EF (Expedited Forwarding)\n  match protocol rtp audio         ! Match RTP audio protocol\n\nclass-map match-all CRITICAL_DATA\n  match ip dscp af31               ! Critical apps = AF31\n  ! Add more matches:\n  ! - Email (SMTP/IMAP port 25, 143, 587)\n  ! - DNS (port 53)\n  ! - SSH (port 22)\n\nclass-map match-all HIGH_PRIORITY\n  match ip dscp af21               ! Business apps = AF21\n\nclass-map match-all MEDIUM_PRIORITY\n  match ip dscp af11               ! General traffic = AF11\n\nclass-map match-all SCAVENGER\n  match ip dscp cs1                ! Low priority = CS1\n\n# Step 2: Define policy map\npolicy-map SHAPE_TO_ISP_CONTRACT\n  class VOIP\n    priority ___              ! Allocate X Mbps to VoIP\n  \n  class CRITICAL_DATA\n    bandwidth percent ___     ! Guarantee X% of remaining\n    queue-limit ___ packets   ! Drop packets if queue exceeds limit\n  \n  class HIGH_PRIORITY\n    bandwidth percent ___     ! Guarantee X% of remaining\n  \n  class MEDIUM_PRIORITY\n    bandwidth percent ___     ! Guarantee X% of remaining\n    random-detect             ! Probabilistic drop to hint TCP to slow down\n  \n  class SCAVENGER\n    bandwidth percent ___     ! Minimal allocation\n  \n  class class-default\n    shape average ___         ! Total shape to 100 Mbps\n    fair-queue                ! Distribute fairly among flows\n\n# Step 3: Apply policy to interface\ninterface GigabitEthernet0/1\n  service-policy output SHAPE_TO_ISP_CONTRACT\n\n# Step 4: Monitor results\n# show policy-map interface GigabitEthernet0/1\n# show policy-map interface GigabitEthernet0/1 class VOIP\n# show policy-map interface GigabitEthernet0/1 drop-queue\n\n# Questions:\n# Q20: Fill in the bandwidth percentages for each class\n# Q21: Why shape average in bps (bits/sec), not Mbps?\n# Q22: What does random-detect do (congestion avoidance)?\n# Q23: How would you verify VoIP traffic is actually marked with DSCP EF?\n\n# ===================================================================\n# CHALLENGE 3: VALIDATE QoS IMPLEMENTATION\n# ===================================================================\n# After implementation, verify it works\n\n# Challenge 3.1: Verify traffic marking\n# Before QoS works, traffic MUST be marked with correct DSCP values\n# Question: How do you mark traffic (VoIP phone marks, router marks, other)?\n#\n# Options:\n# 1. VoIP phone marks packets (Cisco IP phones mark as EF by default) - BEST\n# 2. Router marks based on port (match port 5060, mark as EF) - ACCEPTABLE\n# 3. End device application marks (Zoom marks as AF31) - NOT RELIABLE\n#\n# Diagnostic commands:\n# - show ip dscp packet  (on test traffic)\n# - Wireshark capture (see actual DSCP values in packets)\n#\n# Q24: Design a test: How would you verify VoIP marked as EF?\n# Q25: What if VoIP phones NOT marking correctly (arriving as BE)?\n\n# Challenge 3.2: Validation scenarios\n# Scenario A (Expected behavior):\n# - VoIP call active (2 Mbps EF traffic)\n# - Large file download starts (30 Mbps attempted)\n# - Expected: Download gets 68 Mbps (100 - 2 - 30 for other), VoIP stays at 2 Mbps\n# - Question: Does VoIP experience packet loss or latency increase?\n# - Answer should be: NO (priority queue protects VoIP)\n#\n# Q26: Configure output policy to test\n# Q27: How would you measure jitter/latency to VoIP endpoint?\n#\n# Scenario B (Overage condition):\n# - VoIP: 2 Mbps\n# - File download: 50 Mbps (50 MB file, needs 6.25 Mbps = complete in 8 sec)\n# - Email: 5 Mbps\n# - Web browsing: 43 Mbps\n# - Total: 100 Mbps\n#\n# Question: What happens to each type of traffic?\n# - VoIP: __________ (stays protected at 2 Mbps)\n# - Email: __________ (guaranteed, should be 95% delivery ratio)\n# - File: __________ (gets remaining, may drop some packets)\n# - Web: __________ (scavenger, may drop or slow to crawl)\n#\n# Challenge 3.3: Troubleshooting QoS implementation\n# Problem: After deploying QoS, VoIP quality WORSE than before\n# Symptoms:\n#   - VoIP packets delayed (>150ms RTT)\n#   - Packet loss 3-5% (worse than before)\n#   - Jitter increased to 50ms (from 20ms baseline)\n#\n# Possible causes:\n# 1. VoIP traffic not marked correctly (arriving as BE, treated as default)\n# 2. Priority queue set too low (only getting 2 Mbps, but calls need more with overhead)\n# 3. Policy applied in WRONG direction (inbound vs outbound)\n# 4. Policy not actually applied (show policy-map shows config, but not effective)\n# 5. Router CPU overloaded (complex QoS causing CPU spike)\n#\n# Questions:\n# Q28: Design troubleshooting checklist (steps to diagnose)\n# Q29: What diagnostic commands would you run?\n# Q30: How would you verify policy is actually applied and working?\n# Q31: Root cause identification - which of 5 causes most likely?\n\n# ===================================================================\n# CHALLENGE 4: PERFORMANCE MONITORING AND CAPACITY PLANNING\n# ===================================================================\n# QoS alone doesn't solve congestion, need capacity planning too\n\n# Challenge 4.1: Monitoring effectiveness of QoS\n# After QoS implementation, collect new baseline:\n# - VoIP packet loss: Should drop from 2-3% to <0.5%\n# - VoIP latency: Should stay <150ms (was 200+ ms during congestion)\n# - Email delivery: Should improve to <5 second\n# - File uploads: Should not timeout\n#\n# Metrics to track:\n# - Dropped packets per class (show policy-map output, count drops)\n# - Average latency to destinations (ping continuous baseline)\n# - Call quality metrics (from PBX logs)\n# - User complaints (help desk tickets)\n#\n# Q32: What improvement would indicate QoS is working?\n# Q33: What metric would indicate QoS isn't helping (need more bandwidth)?\n# Q34: Design report to CIO: \"QoS Effectiveness Analysis\"\n\n# Challenge 4.2: When to upgrade ISP\n# Current: 100 Mbps, 95th percentile 76 Mbps, growing 2.8%/month\n# With QoS: Expected to stay below 80 Mbps (some users reduce YouTube)\n# Without users adjusting: 76 Mbps × 1.028^12 = 104 Mbps in 12 months\n#\n# Questions:\n# Q35: If QoS reduces effective demand by 15% (users adapt), new utilization?\n# Q36: Calculate break-even point (when to upgrade)\n# Q37: Recommend upgrade now vs wait 12 months\n# Q38: Include risk analysis (cost of network outage vs upgrade cost)\n\n# ===================================================================\n# DELIVERABLES\n# ===================================================================\n# You must provide:\n# [ ] Baseline data analysis (utilization margins, growth projection, upgrade timeline)\n# [ ] Traffic classification schema (5 traffic classes with examples)\n# [ ] QoS policy configuration (class maps, policy map, interface commands)\n# [ ] Bandwidth allocation design (percentages justified)\n# [ ] Validation plan (how to verify QoS working)\n# [ ] Troubleshooting procedures (if QoS not working, diagnosis steps)\n# [ ] Capacity planning projection (3-year forecast)\n# [ ] ROI analysis (cost of QoS implementation vs cost of congestion)\n# [ ] Business case document (for CIO/CFO review)\n# [ ] Monitoring dashboard specification (metrics to track long-term)",
  "solution": "# NETWORK PERFORMANCE MANAGEMENT - SOLUTION\n# Legal Solutions Group - Complete Implementation\n\n## ===================================================================\n## CHALLENGE 1: BASELINE ANALYSIS AND CAPACITY DECISIONS\n## ===================================================================\n\n### Challenge 1.1: Baseline Analysis\n\n**Q1: Utilization margin**\nCalculation: ISP contract (100 Mbps) - 95th percentile (76 Mbps) = 24 Mbps margin\nPercentage: 24 / 100 = 24% headroom\n\n**Q2: What is 95th percentile?**\nExplanation: If you graph 30 days of 5-minute samples (8,640 samples total), sort highest-to-lowest, 95th percentile is the value where 95% of samples fall below. \n- Ignores top 5% (temporary spikes)\n- Represents \"normal peak\" not extreme peak\n- Industry standard for capacity planning\n- Example: 102 Mbps peak is in top 5% (probably 1-2 samples per month), ignored\n- 76 Mbps represents sustainable load 95% of the time\n\n**Q3: Why 102 Mbps spike concerning?**\nAnswer: \n- ISP contract guarantees 100 Mbps, but 102 Mbps exceeds contract\n- When traffic attempts 102 Mbps, ISP either throttles (introduces 2% packet loss) or carrier drops packets\n- These brief spike-induced packet losses could affect VoIP call quality\n- Without QoS, these drops are random (could hit VoIP, could hit file transfer)\n- Solution: QoS ensures drops affect low-priority traffic, not VoIP\n\n**Q4: 12, 24, 36 month projections**\nFormula: Future = Current × (1 + growth_rate)^months\n- Current 95th: 76 Mbps\n- Growth: 2.8% per month\n- 12 months: 76 × 1.028^12 = 76 × 1.396 = 106 Mbps (EXCEEDS 100 Mbps contract!)\n- 24 months: 76 × 1.028^24 = 76 × 1.948 = 148 Mbps\n- 36 months: 76 × 1.028^36 = 76 × 2.717 = 206 Mbps\n\n**Q5: When to upgrade ISP?**\nRecommendation: UPGRADE NOW\nReasoning:\n- Current 95th percentile: 76 Mbps (76% utilization)\n- Industry best practice: Upgrade when >70% sustained utilization\n- Already AT 76%, exceeds 70% threshold\n- Margin: Only 24 Mbps headroom for growth\n- Risk: In 12 months, will exceed contract capacity\n- Justification to CFO: \"Proactive upgrade now avoids emergency rush upgrade later (rush fees: $50,000+)\"\n\n**Q6: Upgrade capacity recommendation**\nOption analysis:\n- **150 Mbps**: Supports 14 months before hitting 70% (too short window)\n- **200 Mbps**: Supports 32 months before hitting 70% (good, 2.5 year window)\n- **300 Mbps**: Supports 48+ months before hitting 70% (overkill, excessive cost)\n- **500 Mbps**: Way over-capacity, unnecessary cost\n\n**Recommendation: 200 Mbps**\nJustification:\n- Covers 2.5-year growth window (meets business planning cycle)\n- Cost: $2,200/month vs current $1,500 = $700/month additional\n- Aligns with 3-year IT budget planning\n- Provides 2x margin for unexpected growth\n\n### Challenge 1.2: Cost-Benefit Analysis\n\n**Q7: Break-even analysis**\nCost of upgrade: $700/month × 12 months = $8,400/year\nCost of outage: $10,000/day revenue loss if network down\nBreak-even: $8,400 / $10,000 = 0.84 days ≈ **20 hours**\n\nConclusion: One 20-hour network outage pays for the entire year of upgraded service.\nLikelihood: Congestion-induced outage very likely within 12 months if not upgraded.\n\n**Q8: Risk of staying at 100 Mbps**\nRisks:\n1. Network outages: 95th percentile exceeds capacity → packets dropped → applications fail\n2. Revenue loss: Cannot bill clients if network unavailable\n3. Client relationship damage: Missed court deadlines due to network delays = malpractice liability\n4. Emergency remediation: When finally upgrade, will pay rush fees ($50,000+)\n5. Regulatory: Legal firms have business continuity requirements\n\n**Q9: Email to managing partner**\n\"From: Network Team\nTo: Managing Partner\nSubject: Internet Upgrade Recommendation\n\nOur analysis shows the current 100 Mbps connection is at capacity:\n- 95th percentile: 76 Mbps (76% utilization, exceeds safe threshold of 70%)\n- Growth rate: 2.8% monthly means 106 Mbps demand in 12 months\n- Action required: Upgrade to 200 Mbps now ($700/month additional)\n- Cost: $8,400/year additional\n- ROI: One 20-hour outage pays for entire year (likely without action)\n- Alternative: Risk operational outages, client dissatisfaction, malpractice liability\n\nRecommendation: Approve 200 Mbps upgrade effective immediately.\"\n\n### Challenge 1.3: Traffic Analysis\n\n**Q10: Business-critical video vs personal**\nOf the 40 Mbps video:\n- Video conferencing (Zoom, Teams): 5 Mbps - BUSINESS CRITICAL\n- Training videos (Legal Zoom webinars): 3 Mbps - BUSINESS\n- YouTube, Netflix, personal streaming: 32 Mbps - PERSONAL\n\n**Q11: Reduce non-critical bandwidth before upgrade**\nBandwidth savings:\n- Block YouTube: Save 20-25 Mbps immediately\n- Rate-limit Netflix: Save 5-10 Mbps\n- Disable P2P apps: Save 2 Mbps\n- Total possible: 27-37 Mbps reduction = 95th could drop to 40-50 Mbps\n\nBut: This assumes 100% enforcement (users find workarounds)\n\n**Q12: Policy recommendation**\n\"I recommend traffic shaping with QoS rather than blocking:\n- Advantages: Doesn't anger users, still allows access\n- Method: Rate-limit YouTube to 10 Mbps, other video to 5 Mbps\n- Effectiveness: Saves 25-30 Mbps during peak\n- Combined with upgrade to 200 Mbps: Solves problem for 3+ years\"\n\n## ===================================================================\n## CHALLENGE 2: DESIGN QoS AND TRAFFIC SHAPING POLICY\n## ===================================================================\n\n### Challenge 2.1: Traffic Classification\n\n**Q13: Five traffic classes with examples**\n```\n1. CRITICAL (DSCP EF):\n   - VoIP packets (RTP audio, call signaling SIP)\n   - Time-critical protocols (authentication, DNS queries)\n   - Healthcare/emergency apps (if applicable)\n   \n2. HIGH (DSCP AF31):\n   - Email (SMTP, IMAP) - business communication\n   - SSH/telnet (remote access, support)\n   - Critical file transfers (case documents, legal research)\n   \n3. MEDIUM (DSCP AF21):\n   - Web browsing, cloud services\n   - Video conferencing (Zoom, Teams)\n   - General business applications\n   \n4. LOW (DSCP CS1):\n   - YouTube, Netflix, entertainment\n   - BitTorrent, file sharing\n   - Software updates\n   \n5. DEFAULT (DSCP BE, 0):\n   - Everything unmarked\n   - Treated as best-effort\n```\n\n**Q14: Why can't everything be CRITICAL?**\nAnswer: If all traffic marked as CRITICAL:\n- No differentiation between VoIP and YouTube\n- During congestion, both drop equally (unacceptable for VoIP)\n- Entire benefit of QoS lost\n- Wasted effort\n\n**Q15: DSCP values**\n- CRITICAL: EF (Expedited Forwarding, 46) = highest priority\n- HIGH: AF31 (Assured Forwarding 3,1 = 26) = moderate priority, low drop\n- MEDIUM: AF21 (18) = moderate priority, medium drop\n- LOW: CS1 (Class Selector 1 = 8) = low priority, high drop\n- DEFAULT: BE (0) = best effort, drop last\n\n### Challenge 2.2: Traffic Shaping Policy Design\n\n**Q16: Why priority queue for VoIP instead of guaranteed bandwidth?**\nAnswer:\n- VoIP is bursty (sends RTP packets every 20ms, not continuous)\n- Allocating 2 Mbps wastes capacity (actual traffic 0.2-1.5 Mbps)\n- Priority queue: VoIP gets queue served first, but only uses what needed\n- Result: VoIP has 2 Mbps available if needed, but doesn't \"reserve\" unused capacity\n- Benefit: More bandwidth available to other classes when VoIP idle\n\n**Q17: Max bandwidth guarantee to HIGH class**\nCalculation:\n- Total: 100 Mbps (ISP limit)\n- VoIP priority: Allocate 3 Mbps (peak 25 calls × 64 kbps + overhead)\n- Remaining: 97 Mbps available\n- HIGH class: Can guarantee up to 48 Mbps (50% of remaining)\n- Leaves 49 Mbps for MEDIUM, LOW, DEFAULT\n\n**Q18: Prevent HIGH starving LOW**\nAnswer: Use weighted fair queueing (WFQ) in default class:\n- Each flow gets minimum share\n- If HIGH class doesn't use all allocated bandwidth, it overflows to other queues\n- But HIGH traffic ALWAYS gets its guaranteed percentage before others\n\n**Q19: Allow classes to borrow unused bandwidth?**\nAnswer: YES, design it that way\n- VoIP gets 3 Mbps priority, but if not using it, others can borrow\n- HIGH guaranteed 50%, but can use up to 70% if MEDIUM/LOW empty\n- Result: Efficiency improves (no wasted bandwidth)\n- Caveat: When VoIP traffic arrives, gets its 3 Mbps priority immediately\n\n### Challenge 2.3: Implementation\n\n**Q20: Bandwidth percentages for each class**\n```\nVoIP (priority):         3 Mbps (absolute)\nCRITICAL (AF31):        Included in priority\nHIGH (AF21):            50% of remaining (48 Mbps)\nMEDIUM (AF11):          30% of remaining (29 Mbps)\nLOW (CS1):              10% of remaining (10 Mbps)\nDEFAULT (BE):           7 Mbps (reserve)\nShape average:          100,000,000 bps (100 Mbps)\n```\n\n**Q21: Why shape in bps (bits/sec), not Mbps?**\nAnswer: Device configuration requires smallest units\n- 100 Mbps = 100,000,000 bps\n- Router natively works in bps\n- Easier to calculate percentage allocations from bps\n\n**Q22: Random-detect function**\nAnswer: Congestion avoidance mechanism\n- When queue exceeds threshold, randomly drop packets\n- Signals TCP to slow transmission (TCP congestion control)\n- Prevents queue overflow (which would drop ALL packets)\n- Better than tail-drop (drops entire queue tail, loses multiple packets from same flow)\n\n**Q23: Verify DSCP marking**\nCommands:\n```\nRouter# debug ip dscp packet\n(captures packets, shows DSCP values)\n\nRouter# show policy-map interface GigabitEthernet0/1\n(shows class statistics, drops, forwarding)\n\nWireshark capture:\n- Filter: dscp\n- Verify VoIP packets show DSCP=46 (EF)\n- Verify web shows DSCP=0 (BE) or 18 (AF21)\n```\n\n## ===================================================================\n## CHALLENGE 3: VALIDATE QoS IMPLEMENTATION\n## ===================================================================\n\n**Q24: Test to verify VoIP marked as EF**\nProcedure:\n1. Capture traffic from VoIP phone using Wireshark\n2. Filter for RTP packets (payload type audio)\n3. Check DSCP field in IP header (should be 46 = EF)\n4. If not marked, router must mark it (configure class-map match port 5060)\n\n**Q25: If VoIP phones NOT marking correctly**\nSolution: Configure router to mark based on port\n```\nclass-map match-all VOIP\n  match ip dscp ef               ! Also match if already marked\n  match port 5060               ! SIP signaling\n  match port 16384-32767 rtp    ! RTP audio range\n!\npolicy-map MARK_VOIP\n  class VOIP\n    set ip dscp ef              ! Mark as EF if not already\n```\n\n**Q26: Configure output policy**\n```\ninterface GigabitEthernet0/0/1 (Internet uplink)\n  service-policy output SHAPE_TO_ISP_CONTRACT\n  ! Policy ensures VoIP gets 3 Mbps priority\n```\n\n**Q27: Measure jitter/latency to VoIP endpoint**\nTools:\n- Ping continuous: `ping -i 0.1 <voip_phone_ip>` captures 10 samples/sec\n- Calculate jitter: Standard deviation of RTT values\n- Expected: <30ms jitter, <150ms RTT\n- With QoS working: Should see low latency even during congestion\n\n**Q28-Q31: Troubleshooting if VoIP quality WORSE**\n\nDiagnostic checklist:\n1. **Verify traffic marking**\n   - `show policy-map interface Gi0/1 | include VOIP`\n   - Should show packets flowing through VOIP class\n   \n2. **Verify policy applied**\n   - `show policy-map interface Gi0/1`\n   - Should show policy active, not just configured\n   \n3. **Check policy direction**\n   - Output policy: Shapes outbound (Internet direction) ✓ CORRECT\n   - Input policy: Would shape inbound (opposite) ✗ WRONG\n   \n4. **Monitor dropped packets**\n   - `show policy-map interface Gi0/1 | include dropped`\n   - If VOIP class showing drops = priority queue insufficient\n   - Solution: Increase priority allocation (e.g., 5 Mbps instead of 3)\n   \n5. **Check router CPU**\n   - `show processes cpu sorted | head`\n   - If CPU >80%, complex QoS causing overhead\n   - Solution: Simplify policy or upgrade router\n\n**Q29: Diagnostic commands**\n```\nshow policy-map interface GigabitEthernet0/1\nshow policy-map interface GigabitEthernet0/1 class VOIP\nshow queue interface GigabitEthernet0/1\nshow interfaces GigabitEthernet0/1 | include input/output drops\nshow processes cpu sorted\ndebug policy-map action\n```\n\n**Q30: Verify policy is working**\nSign of working QoS:\n- VoIP class packets delivered (show queue = 0 drops for VOIP)\n- Dropped packets in MEDIUM/LOW/DEFAULT (not VOIP)\n- VoIP latency stable even when other traffic peaks\n- Help desk VoIP complaint calls drop significantly\n\n**Q31: Root cause if VoIP quality worse**\nMost likely: Traffic not marked as EF (arrives as BE, treated as default)\nSecond likely: Priority queue too low (insufficient for call count + overhead)\nLeast likely: Policy not applied (would need to verify with show commands)\n\n## ===================================================================\n## CHALLENGE 4: PERFORMANCE MONITORING AND CAPACITY PLANNING\n## ===================================================================\n\n**Q32: What improvement indicates QoS working?**\n- VoIP packet loss drops from 2-3% to <0.5% ✓ PRIMARY INDICATOR\n- VoIP latency stays <150ms during congestion ✓ SECONDARY\n- File uploads complete successfully (timeout rate 0%) ✓ TERTIARY\n- Help desk: VoIP complaint tickets drop 80%+ ✓ BUSINESS METRIC\n\n**Q33: Metric indicating QoS NOT helping**\n- VoIP still dropping 2-3% despite QoS: Indicates underlying ISP congestion, need more bandwidth\n- Latency still >200ms: Indicates ISP has its own congestion (QoS can't help upstream)\n- File transfer timeouts continue: Indicates ISP limiting throughput\n\n**Q34: Report to CIO - QoS Effectiveness Analysis**\n\"Executive Summary:\nQoS implementation successful. VoIP quality improved 85% (packet loss 3% → 0.4%).\n\nMetrics:\n- VoIP call success rate: 99.6% (was 97%)\n- Email delivery time: <2 seconds (was 5-8 seconds)\n- File upload success: 99.9% (was 95%)\n- User complaints: Down 75%\n\nConclusion: QoS buying time until ISP upgrade complete (200 Mbps planned for Q2)\"\n\n**Q35: Utilization with QoS and user adaptation**\nIf 15% effective demand reduction:\n- Current peak: 94 Mbps\n- Reduction: 94 × 0.15 = 14 Mbps saved\n- New peak: 94 - 14 = 80 Mbps (within capacity)\n- 95th percentile: ~65 Mbps\n- Margin: 35 Mbps (good)\n\n**Q36: Break-even for upgrade**\nWithout user adaptation:\n- 76 Mbps × 1.028^12 = 106 Mbps (exceeds 100 Mbps in 12 months)\n\nWith 15% adaptation:\n- (76 × 0.85) Mbps × 1.028^12 = (65 × 1.396) = 91 Mbps (still within 100 Mbps)\n- Add 2.8% growth for 24 months: 91 × 1.028^12 = 127 Mbps\n- **Break-even: 18-20 months** (upgrade during Q4 2026)\n\n**Q37: Upgrade recommendation**\n\"QoS provides breathing room but not permanent solution. Recommend:\n- Now: Implement QoS ($5,000 one-time, 15% savings)\n- 12 months: Monitor actual utilization\n- 18 months: Upgrade to 200 Mbps if sustained >70%\n- This balances cost vs performance vs risk\"\n\n**Q38: Risk analysis**\nCosts:\n- QoS implementation: $5,000\n- 200 Mbps upgrade: $700/month = $8,400/year\n\nRisks without action:\n- Network outage: $10,000/day revenue loss\n- Client relationship damage: Unquantifiable\n- Malpractice liability: High (missed deadlines)\n- Rush upgrade fees: $50,000+ if emergency\n\nConclusion: Cost of upgrade ($8,400/year) << Risk of outage ($10,000/day)\nRecommendation: Proceed with QoS now, upgrade ISP Q4 2026",
  "hints": [
    "95th percentile represents sustainable load, peak spikes ignored - use for capacity planning",
    "Traffic shaping (shape average) prevents exceeding ISP contract rate, QoS prioritizes critical traffic - both needed",
    "VoIP on priority queue (not percentage-based) because it's bursty and small - saves bandwidth for other classes when idle",
    "DSCP marking critical - if packets arrive unmarked, QoS cannot differentiate, must mark at source or router",
    "Traffic classification must match business reality - what IS critical vs what FEELS critical to users",
    "Bandwidth guarantees require careful math - can't guarantee >100 Mbps on 100 Mbps link",
    "Random-detect TCP congestion avoidance better than tail-drop - prevents synchronized TCP backoff",
    "QoS solves prioritization but NOT overall congestion - if sustained demand exceeds capacity, need bandwidth upgrade too",
    "Monitoring effectiveness of QoS essential - metric to track: VoIP packet loss drop from 2-3% to <0.5%",
    "Cost-benefit: One 20-hour outage worth entire year of bandwidth upgrade - failure expensive"
  ],
  "testCases": [
    {
      "id": "tc1-baseline",
      "description": "Baseline data analysis - 95th percentile and utilization calculation",
      "input": "Baseline analysis",
      "expected": "95th percentile 76 Mbps, 24% margin, exceeds 70% threshold",
      "assert": "assert '76' in solution and 'percentile' in solution.lower() and '24' in solution",
      "isHidden": false
    },
    {
      "id": "tc2-projection",
      "description": "Growth projection for 12/24/36 months",
      "input": "Capacity planning",
      "expected": "12mo: 106 Mbps, 24mo: 148 Mbps, 36mo: 206 Mbps",
      "assert": "assert ('106' in solution or 'growth' in solution.lower()) and ('upgrade' in solution.lower() or '200' in solution)",
      "isHidden": false
    },
    {
      "id": "tc3-classmaps",
      "description": "Traffic classification with DSCP values",
      "input": "QoS design",
      "expected": "Five classes with DSCP (EF, AF31, AF21, AF11, CS1)",
      "assert": "assert 'EF' in solution and 'AF31' in solution and 'AF21' in solution",
      "isHidden": false
    },
    {
      "id": "tc4-voip-priority",
      "description": "VoIP priority queue configuration",
      "input": "VoIP allocation",
      "expected": "Priority queue for VoIP with 2-3 Mbps allocation",
      "assert": "assert 'priority' in solution.lower() and ('voip' in solution.lower() or 'rtp' in solution.lower())",
      "isHidden": false
    },
    {
      "id": "tc5-shaping",
      "description": "Traffic shaping to 100 Mbps (100,000,000 bps)",
      "input": "Shape average",
      "expected": "Shape average configured to match ISP contract rate",
      "assert": "assert 'shape' in solution.lower() and ('100' in solution or '100000000' in solution)",
      "isHidden": false
    },
    {
      "id": "tc6-policy-application",
      "description": "Policy applied to internet uplink interface",
      "input": "Interface configuration",
      "expected": "Service-policy output on GigabitEthernet0/1",
      "assert": "assert 'service-policy' in solution.lower() and 'output' in solution.lower()",
      "isHidden": false
    },
    {
      "id": "tc7-validation",
      "description": "Validation procedures for QoS effectiveness",
      "input": "Testing and verification",
      "expected": "Diagnostic commands and expected results documented",
      "assert": "assert ('show policy-map' in solution or 'verify' in solution.lower() or 'test' in solution.lower()) and ('voip' in solution.lower() or 'packet' in solution.lower())",
      "isHidden": false
    },
    {
      "id": "tc8-troubleshooting",
      "description": "Troubleshooting if VoIP quality worse after QoS",
      "input": "Problem resolution",
      "expected": "Root causes identified and diagnostic steps documented",
      "assert": "assert ('dscp' in solution.lower() or 'mark' in solution.lower()) and ('troubleshoot' in solution.lower() or 'diagnose' in solution.lower())",
      "isHidden": false
    },
    {
      "id": "tc9-costbenefit",
      "description": "ROI calculation - upgrade cost vs outage risk",
      "input": "Financial analysis",
      "expected": "Break-even calculation showing upgrade justified",
      "assert": "assert ('$8,400' in solution or '8400' in solution or 'break-even' in solution.lower() or 'roi' in solution.lower())",
      "isHidden": false
    },
    {
      "id": "tc10-monitoring",
      "description": "Monitoring metrics for QoS effectiveness",
      "input": "Performance tracking",
      "expected": "VoIP packet loss improvement 2-3% to <0.5%",
      "assert": "assert ('packet' in solution.lower() or 'loss' in solution.lower() or 'voip' in solution.lower()) and ('metric' in solution.lower() or 'monitor' in solution.lower())",
      "isHidden": false
    },
    {
      "id": "tc11-scenarios",
      "description": "All 4 challenges addressed",
      "input": "Challenge coverage",
      "expected": "Baseline, QoS design, validation, monitoring all covered",
      "assert": "assert 'CHALLENGE 1' in solution and 'CHALLENGE 2' in solution and 'CHALLENGE 3' in solution and 'CHALLENGE 4' in solution",
      "isHidden": false
    },
    {
      "id": "tc12-filesize",
      "description": "Comprehensive performance management documentation",
      "input": "Document length",
      "expected": "Minimum 12,000 character detailed exercise",
      "assert": "assert len(solution) >= 12000",
      "isHidden": false
    }
  ]
}
