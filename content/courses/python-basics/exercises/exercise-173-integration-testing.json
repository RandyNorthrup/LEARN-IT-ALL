{
  "id": "exercise-173-integration-testing",
  "lessonId": "lesson-163-integration-testing",
  "title": "Integration Testing",
  "description": "Write integration tests, test component interactions, set up test environments, and test database operations.",
  "difficulty": "advanced",
  "points": 25,
  "starterCode": "# Exercise: Integration Testing\nimport sqlite3\n\nclass UserRepository:\n    \"\"\"User repository for database operations.\"\"\"\n    pass\n\nclass OrderRepository:\n    \"\"\"Order repository for database operations.\"\"\"\n    pass\n\nclass OrderService:\n    \"\"\"Service integrating user and order repositories.\"\"\"\n    pass\n\nclass EmailService:\n    \"\"\"Email service for notifications.\"\"\"\n    pass\n\nclass UserRegistrationFlow:\n    \"\"\"Complete user registration workflow.\"\"\"\n    pass\n\nclass APIClient:\n    \"\"\"API client for testing endpoints.\"\"\"\n    pass\n",
  "solution": "# Solution: Integration Testing\nimport sqlite3\nfrom typing import Optional, List, Dict\nfrom dataclasses import dataclass\n\n@dataclass\nclass User:\n    \"\"\"User model.\"\"\"\n    id: int\n    username: str\n    email: str\n\nclass UserRepository:\n    \"\"\"User repository for database operations.\"\"\"\n    \n    def __init__(self, conn: sqlite3.Connection):\n        self.conn = conn\n    \n    def create_user(self, username: str, email: str) -> User:\n        \"\"\"Create user in database.\"\"\"\n        cursor = self.conn.cursor()\n        cursor.execute(\n            \"INSERT INTO users (username, email) VALUES (?, ?)\",\n            (username, email)\n        )\n        self.conn.commit()\n        \n        user_id = cursor.lastrowid\n        return User(id=user_id, username=username, email=email)\n    \n    def get_user(self, user_id: int) -> Optional[User]:\n        \"\"\"Get user by ID.\"\"\"\n        cursor = self.conn.cursor()\n        cursor.execute(\"SELECT * FROM users WHERE id = ?\", (user_id,))\n        row = cursor.fetchone()\n        \n        if row:\n            return User(id=row[0], username=row[1], email=row[2])\n        return None\n    \n    def get_user_by_email(self, email: str) -> Optional[User]:\n        \"\"\"Get user by email.\"\"\"\n        cursor = self.conn.cursor()\n        cursor.execute(\"SELECT * FROM users WHERE email = ?\", (email,))\n        row = cursor.fetchone()\n        \n        if row:\n            return User(id=row[0], username=row[1], email=row[2])\n        return None\n\nclass OrderRepository:\n    \"\"\"Order repository for database operations.\"\"\"\n    \n    def __init__(self, conn: sqlite3.Connection):\n        self.conn = conn\n    \n    def create_order(self, user_id: int, total: float) -> int:\n        \"\"\"Create order for user.\"\"\"\n        cursor = self.conn.cursor()\n        cursor.execute(\n            \"INSERT INTO orders (user_id, total, status) VALUES (?, ?, ?)\",\n            (user_id, total, \"pending\")\n        )\n        self.conn.commit()\n        return cursor.lastrowid\n    \n    def get_orders_by_user(self, user_id: int) -> List[Dict]:\n        \"\"\"Get all orders for user.\"\"\"\n        cursor = self.conn.cursor()\n        cursor.execute(\"SELECT * FROM orders WHERE user_id = ?\", (user_id,))\n        \n        orders = []\n        for row in cursor.fetchall():\n            orders.append({\n                \"id\": row[0],\n                \"user_id\": row[1],\n                \"total\": row[2],\n                \"status\": row[3]\n            })\n        return orders\n\nclass OrderService:\n    \"\"\"Service integrating user and order repositories.\"\"\"\n    \n    def __init__(self, user_repo: UserRepository, order_repo: OrderRepository):\n        self.users = user_repo\n        self.orders = order_repo\n    \n    def create_order_for_user(self, email: str, total: float) -> Dict:\n        \"\"\"\n        Create order for user by email.\n        \n        Returns:\n            Order details with user info\n        \"\"\"\n        # Get user\n        user = self.users.get_user_by_email(email)\n        if not user:\n            raise ValueError(f\"User not found: {email}\")\n        \n        # Create order\n        order_id = self.orders.create_order(user.id, total)\n        \n        return {\n            \"order_id\": order_id,\n            \"user_id\": user.id,\n            \"username\": user.username,\n            \"total\": total\n        }\n    \n    def get_user_order_summary(self, email: str) -> Dict:\n        \"\"\"\n        Get summary of user orders.\n        \n        Returns:\n            User info with order statistics\n        \"\"\"\n        user = self.users.get_user_by_email(email)\n        if not user:\n            raise ValueError(f\"User not found: {email}\")\n        \n        orders = self.orders.get_orders_by_user(user.id)\n        total_spent = sum(order[\"total\"] for order in orders)\n        \n        return {\n            \"username\": user.username,\n            \"email\": user.email,\n            \"order_count\": len(orders),\n            \"total_spent\": total_spent\n        }\n\nclass EmailService:\n    \"\"\"Email service for notifications.\"\"\"\n    \n    def __init__(self):\n        self.sent_emails = []\n    \n    def send_welcome_email(self, email: str, username: str) -> bool:\n        \"\"\"Send welcome email to new user.\"\"\"\n        email_data = {\n            \"to\": email,\n            \"subject\": \"Welcome!\",\n            \"body\": f\"Welcome {username}!\"\n        }\n        self.sent_emails.append(email_data)\n        return True\n    \n    def get_sent_count(self) -> int:\n        \"\"\"Get count of sent emails.\"\"\"\n        return len(self.sent_emails)\n\nclass UserRegistrationFlow:\n    \"\"\"Complete user registration workflow.\"\"\"\n    \n    def __init__(self, user_repo: UserRepository, email_service: EmailService):\n        self.users = user_repo\n        self.emails = email_service\n    \n    def register_user(self, username: str, email: str) -> User:\n        \"\"\"\n        Register user and send welcome email.\n        \n        Returns:\n            Created user\n        \"\"\"\n        # Check if user exists\n        existing = self.users.get_user_by_email(email)\n        if existing:\n            raise ValueError(f\"Email already registered: {email}\")\n        \n        # Create user\n        user = self.users.create_user(username, email)\n        \n        # Send welcome email\n        self.emails.send_welcome_email(email, username)\n        \n        return user\n\nclass APIClient:\n    \"\"\"API client for testing endpoints.\"\"\"\n    \n    def __init__(self, base_url: str = \"http://api.example.com\"):\n        self.base_url = base_url\n        self.responses = {}\n    \n    def get(self, endpoint: str) -> Dict:\n        \"\"\"Mock GET request.\"\"\"\n        return self.responses.get(endpoint, {\"status\": 404})\n    \n    def post(self, endpoint: str, data: Dict) -> Dict:\n        \"\"\"Mock POST request.\"\"\"\n        return {\"status\": 201, \"data\": data}\n    \n    def set_response(self, endpoint: str, response: Dict):\n        \"\"\"Set mock response for endpoint.\"\"\"\n        self.responses[endpoint] = response\n\n# Integration test fixtures and tests\n\nimport pytest\n\n@pytest.fixture\ndef test_db():\n    \"\"\"Create in-memory test database.\"\"\"\n    conn = sqlite3.connect(\":memory:\")\n    cursor = conn.cursor()\n    \n    # Create tables\n    cursor.execute(\"\"\"\n        CREATE TABLE users (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            username TEXT NOT NULL,\n            email TEXT NOT NULL UNIQUE\n        )\n    \"\"\")\n    \n    cursor.execute(\"\"\"\n        CREATE TABLE orders (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            user_id INTEGER NOT NULL,\n            total REAL NOT NULL,\n            status TEXT NOT NULL,\n            FOREIGN KEY (user_id) REFERENCES users(id)\n        )\n    \"\"\")\n    \n    conn.commit()\n    yield conn\n    conn.close()\n\n@pytest.fixture\ndef user_repo(test_db):\n    \"\"\"User repository with test database.\"\"\"\n    return UserRepository(test_db)\n\n@pytest.fixture\ndef order_repo(test_db):\n    \"\"\"Order repository with test database.\"\"\"\n    return OrderRepository(test_db)\n\n@pytest.fixture\ndef order_service(user_repo, order_repo):\n    \"\"\"Order service with repositories.\"\"\"\n    return OrderService(user_repo, order_repo)\n\n@pytest.fixture\ndef email_service():\n    \"\"\"Email service for testing.\"\"\"\n    return EmailService()\n\n@pytest.fixture\ndef registration_flow(user_repo, email_service):\n    \"\"\"User registration flow.\"\"\"\n    return UserRegistrationFlow(user_repo, email_service)\n\n# Integration tests\n\ndef test_user_repository_integration(user_repo):\n    \"\"\"Test user repository database operations.\"\"\"\n    # Create user\n    user = user_repo.create_user(\"alice\", \"alice@example.com\")\n    assert user.id is not None\n    assert user.username == \"alice\"\n    \n    # Get user by ID\n    retrieved = user_repo.get_user(user.id)\n    assert retrieved.username == \"alice\"\n    \n    # Get user by email\n    found = user_repo.get_user_by_email(\"alice@example.com\")\n    assert found.id == user.id\n\ndef test_order_service_integration(order_service, user_repo):\n    \"\"\"Test order service with user and order repos.\"\"\"\n    # Create user first\n    user_repo.create_user(\"bob\", \"bob@example.com\")\n    \n    # Create order through service\n    order = order_service.create_order_for_user(\"bob@example.com\", 100.0)\n    \n    assert order[\"username\"] == \"bob\"\n    assert order[\"total\"] == 100.0\n    \n    # Get order summary\n    summary = order_service.get_user_order_summary(\"bob@example.com\")\n    assert summary[\"order_count\"] == 1\n    assert summary[\"total_spent\"] == 100.0\n\ndef test_user_registration_flow_integration(registration_flow, email_service):\n    \"\"\"Test complete user registration workflow.\"\"\"\n    # Register user\n    user = registration_flow.register_user(\"charlie\", \"charlie@example.com\")\n    \n    assert user.username == \"charlie\"\n    assert user.email == \"charlie@example.com\"\n    \n    # Verify email was sent\n    assert email_service.get_sent_count() == 1\n\ndef test_multi_component_integration(test_db):\n    \"\"\"Test multiple components working together.\"\"\"\n    # Setup all components\n    user_repo = UserRepository(test_db)\n    order_repo = OrderRepository(test_db)\n    email_service = EmailService()\n    \n    # Register user\n    flow = UserRegistrationFlow(user_repo, email_service)\n    user = flow.register_user(\"dave\", \"dave@example.com\")\n    \n    # Create orders\n    service = OrderService(user_repo, order_repo)\n    service.create_order_for_user(\"dave@example.com\", 50.0)\n    service.create_order_for_user(\"dave@example.com\", 75.0)\n    \n    # Verify complete state\n    summary = service.get_user_order_summary(\"dave@example.com\")\n    assert summary[\"order_count\"] == 2\n    assert summary[\"total_spent\"] == 125.0\n    assert email_service.get_sent_count() == 1\n\ndef test_api_client_integration():\n    \"\"\"Test API client mock integration.\"\"\"\n    client = APIClient()\n    \n    # Set mock response\n    client.set_response(\"/users/1\", {\"id\": 1, \"name\": \"Alice\"})\n    \n    # Make request\n    response = client.get(\"/users/1\")\n    assert response[\"id\"] == 1\n    assert response[\"name\"] == \"Alice\"\n    \n    # Test POST\n    result = client.post(\"/users\", {\"name\": \"Bob\"})\n    assert result[\"status\"] == 201\n",
  "hints": [
    "Test database: Use sqlite3.connect(':memory:') for in-memory database",
    "Fixtures: Create @pytest.fixture for database, repositories, services",
    "Setup schema: Execute CREATE TABLE in database fixture",
    "Integration test: Test multiple components together, verify interactions",
    "Cleanup: Use yield in fixture to run cleanup after test",
    "Real flow: Test realistic workflows (register → create order → verify)"
  ],
  "testCases": [
    {
      "input": "import sqlite3\\nconn = sqlite3.connect(':memory:')\\nconn.execute('CREATE TABLE users (id INTEGER PRIMARY KEY, username TEXT, email TEXT)')\\nconn.commit()\\nrepo = UserRepository(conn)\\nuser = repo.create_user('alice', 'alice@example.com')\\nuser.username",
      "description": "Test UserRepository create",
      "id": "test1",
      "expectedOutput": "'alice'",
      "isHidden": false
    },
    {
      "input": "import sqlite3\\nconn = sqlite3.connect(':memory:')\\nconn.execute('CREATE TABLE users (id INTEGER PRIMARY KEY, username TEXT, email TEXT)')\\nconn.execute('CREATE TABLE orders (id INTEGER PRIMARY KEY, user_id INTEGER, total REAL, status TEXT)')\\nconn.commit()\\nuser_repo = UserRepository(conn)\\norder_repo = OrderRepository(conn)\\nuser_repo.create_user('bob', 'bob@example.com')\\nservice = OrderService(user_repo, order_repo)\\norder = service.create_order_for_user('bob@example.com', 100.0)\\norder['username']",
      "description": "Test OrderService integration",
      "id": "test2",
      "expectedOutput": "'bob'",
      "isHidden": false
    },
    {
      "input": "email_service = EmailService()\\nemail_service.send_welcome_email('test@ex.com', 'Test')\\nemail_service.get_sent_count()",
      "description": "Test EmailService",
      "id": "test3",
      "expectedOutput": "1",
      "isHidden": false
    },
    {
      "input": "import sqlite3\\nconn = sqlite3.connect(':memory:')\\nconn.execute('CREATE TABLE users (id INTEGER PRIMARY KEY, username TEXT, email TEXT)')\\nconn.commit()\\nuser_repo = UserRepository(conn)\\nemail_service = EmailService()\\nflow = UserRegistrationFlow(user_repo, email_service)\\nuser = flow.register_user('test', 'test@example.com')\\n(user.username, email_service.get_sent_count())",
      "description": "Test registration flow",
      "id": "test4",
      "expectedOutput": "('test', 1)",
      "isHidden": true
    },
    {
      "input": "client = APIClient()\\nclient.set_response('/test', {'status': 200})\\nresponse = client.get('/test')\\nresponse['status']",
      "description": "Test APIClient mock",
      "id": "test5",
      "expectedOutput": "200",
      "isHidden": true
    },
    {
      "input": "import sqlite3\\nconn = sqlite3.connect(':memory:')\\nconn.execute('CREATE TABLE users (id INTEGER PRIMARY KEY, username TEXT, email TEXT)')\\nconn.execute('CREATE TABLE orders (id INTEGER PRIMARY KEY, user_id INTEGER, total REAL, status TEXT)')\\nconn.commit()\\nuser_repo = UserRepository(conn)\\norder_repo = OrderRepository(conn)\\nuser_repo.create_user('test', 'test@example.com')\\nservice = OrderService(user_repo, order_repo)\\nservice.create_order_for_user('test@example.com', 50.0)\\nservice.create_order_for_user('test@example.com', 75.0)\\nsummary = service.get_user_order_summary('test@example.com')\\nsummary['total_spent']",
      "description": "Test order summary",
      "id": "test6",
      "expectedOutput": "125.0",
      "isHidden": true
    }
  ],
  "language": "python"
}