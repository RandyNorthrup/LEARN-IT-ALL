{
  "id": "exercise-099-advanced-pattern-matching",
  "lessonId": "lesson-091-advanced-pattern-matching",
  "title": "Event Router System",
  "description": "Build an event routing and processing system using Python 3.10+ pattern matching with structural patterns, guards, and complex matching.\n\nYour program should:\n1. Match different event types and structures\n2. Use guards for additional conditions\n3. Destructure nested data structures\n4. Implement OR patterns for multiple matches\n5. Build practical command parsers\n\nImplement these functions:\n- `route_event(event)`: Route different event types\n- `parse_command(command_string)`: Parse and validate commands\n- `process_api_response(response)`: Handle various API response structures\n- `analyze_data_structure(data)`: Match and describe data patterns\n- `handle_user_action(action, user)`: Complex action routing with guards\n\nExample:\n```python\nresult = route_event({'type': 'user_login', 'user_id': 123})\n# Routes to appropriate handler based on pattern\n```",
  "difficulty": "advanced",
  "points": 25,
  "language": "python",
  "starterCode": "def route_event(event):\n    \"\"\"Route events using pattern matching.\"\"\"\n    # TODO: Use match-case to handle different event types:\n    # - {'type': 'user_login', 'user_id': id}: f'User {id} logged in'\n    # - {'type': 'user_logout', 'user_id': id}: f'User {id} logged out'\n    # - {'type': 'purchase', 'user_id': id, 'amount': amt} if amt > 100:\n    #   f'Large purchase: User {id} spent ${amt}'\n    # - {'type': 'purchase', 'user_id': id, 'amount': amt}:\n    #   f'Purchase: User {id} spent ${amt}'\n    # - {'type': 'error', 'message': msg}: f'Error: {msg}'\n    # - _: 'Unknown event'\n    \n    pass\n\ndef parse_command(command_string):\n    \"\"\"Parse command string using pattern matching.\"\"\"\n    # TODO: Split command_string and match patterns:\n    # - ['quit'] | ['exit']: return 'Exiting program'\n    # - ['help']: return 'Available commands: quit, help, add, list, delete'\n    # - ['add', *items] if items: return f'Adding: {\", \".join(items)}'\n    # - ['add']: return 'Error: add requires items'\n    # - ['delete', item_id] if item_id.isdigit():\n    #   return f'Deleting item #{item_id}'\n    # - ['delete', item_id]: return f'Error: {item_id} is not a valid ID'\n    # - ['list']: return 'Listing all items'\n    # - []: return 'No command entered'\n    # - [cmd, *_]: return f'Unknown command: {cmd}'\n    \n    pass\n\ndef process_api_response(response):\n    \"\"\"Process different API response structures.\"\"\"\n    # TODO: Match response patterns:\n    # - {'status': 'success', 'data': {'user': {'name': name, 'id': id}}}:\n    #   return f'User: {name} (ID: {id})'\n    # - {'status': 'success', 'data': {'users': users}} if len(users) > 0:\n    #   return f'Found {len(users)} users'\n    # - {'status': 'success', 'data': []}:\n    #   return 'No data found'\n    # - {'status': 'error', 'code': code, 'message': msg}:\n    #   return f'Error {code}: {msg}'\n    # - {'status': 'error', 'message': msg}:\n    #   return f'Error: {msg}'\n    # - _: return 'Invalid response format'\n    \n    pass\n\ndef analyze_data_structure(data):\n    \"\"\"Analyze and describe data structure patterns.\"\"\"\n    # TODO: Match data patterns:\n    # - []: 'Empty list'\n    # - [single]: f'Single item: {single}'\n    # - [first, second]: f'Pair: {first}, {second}'\n    # - [first, *middle, last] if len(middle) > 0:\n    #   f'List: first={first}, middle={len(middle)} items, last={last}'\n    # - {}: 'Empty dict'\n    # - {'type': t, 'value': v}: f'Typed value: {t} = {v}'\n    # - dict() as d if len(d) > 0: f'Dict with {len(d)} keys'\n    # - int(n) if n > 0: f'Positive integer: {n}'\n    # - int(n) if n < 0: f'Negative integer: {n}'\n    # - str(s): f'String: {s}'\n    # - _: 'Unknown structure'\n    \n    pass\n\ndef handle_user_action(action, user):\n    \"\"\"Handle user actions with pattern matching and guards.\"\"\"\n    # TODO: Match (action, user) tuple:\n    # - ('login', {'username': uname, 'password': pwd}) if uname and pwd:\n    #   return f'Logging in user: {uname}'\n    # - ('login', _): return 'Error: Missing credentials'\n    # - ('post', {'role': 'admin', 'content': content}):\n    #   return f'Admin posting: {content[:50]}'\n    # - ('post', {'role': 'user', 'content': content}) if len(content) <= 280:\n    #   return f'User posting: {content}'\n    # - ('post', {'role': 'user', 'content': _}):\n    #   return 'Error: Post too long (max 280 chars)'\n    # - ('delete', {'role': 'admin', 'item_id': item_id}):\n    #   return f'Admin deleting item {item_id}'\n    # - ('delete', {'role': 'user'}): return 'Error: Permission denied'\n    # - (act, _): return f'Unknown action: {act}'\n    \n    pass\n\n# Test the functions\nprint(\"Event Routing:\")\nprint(\"=\"*60)\nevents = [\n    {'type': 'user_login', 'user_id': 123},\n    {'type': 'user_logout', 'user_id': 456},\n    {'type': 'purchase', 'user_id': 789, 'amount': 150},\n    {'type': 'purchase', 'user_id': 101, 'amount': 25},\n    {'type': 'error', 'message': 'Database connection failed'},\n    {'type': 'unknown'},\n]\n\nfor event in events:\n    result = route_event(event)\n    print(f\"Event: {event.get('type', 'unknown')}\")\n    print(f\"Result: {result}\\n\")\n\nprint(\"=\"*60)\nprint(\"Command Parsing:\")\nprint(\"=\"*60)\ncommands = [\n    'quit',\n    'help',\n    'add apple banana cherry',\n    'add',\n    'delete 42',\n    'delete abc',\n    'list',\n    '',\n    'invalid command here',\n]\n\nfor cmd in commands:\n    result = parse_command(cmd)\n    print(f\"Command: '{cmd}'\")\n    print(f\"Result: {result}\\n\")\n\nprint(\"=\"*60)\nprint(\"API Response Processing:\")\nprint(\"=\"*60)\nresponses = [\n    {'status': 'success', 'data': {'user': {'name': 'Alice', 'id': 1}}},\n    {'status': 'success', 'data': {'users': [{'name': 'Bob'}, {'name': 'Charlie'}]}},\n    {'status': 'success', 'data': []},\n    {'status': 'error', 'code': 404, 'message': 'Not found'},\n    {'status': 'error', 'message': 'Server error'},\n    {'invalid': 'response'},\n]\n\nfor response in responses:\n    result = process_api_response(response)\n    print(f\"Response: {response}\")\n    print(f\"Result: {result}\\n\")\n\nprint(\"=\"*60)\nprint(\"Data Structure Analysis:\")\nprint(\"=\"*60)\ndata_samples = [\n    [],\n    [42],\n    [1, 2],\n    [1, 2, 3, 4, 5],\n    {},\n    {'type': 'user', 'value': 'Alice'},\n    {'name': 'Bob', 'age': 30},\n    42,\n    -10,\n    'hello',\n]\n\nfor data in data_samples:\n    result = analyze_data_structure(data)\n    print(f\"Data: {data}\")\n    print(f\"Analysis: {result}\\n\")\n\nprint(\"=\"*60)\nprint(\"User Action Handling:\")\nprint(\"=\"*60)\naction_tests = [\n    ('login', {'username': 'alice', 'password': 'secret'}),\n    ('login', {'username': 'bob'}),\n    ('post', {'role': 'admin', 'content': 'Admin announcement'}),\n    ('post', {'role': 'user', 'content': 'Short post'}),\n    ('post', {'role': 'user', 'content': 'x' * 300}),\n    ('delete', {'role': 'admin', 'item_id': 123}),\n    ('delete', {'role': 'user', 'item_id': 456}),\n]\n\nfor action, user in action_tests:\n    result = handle_user_action(action, user)\n    print(f\"Action: {action}, User role: {user.get('role', 'N/A')}\")\n    print(f\"Result: {result}\\n\")",
  "solution": "def route_event(event):\n    \"\"\"Route events using pattern matching.\"\"\"\n    match event:\n        case {'type': 'user_login', 'user_id': user_id}:\n            return f'User {user_id} logged in'\n        \n        case {'type': 'user_logout', 'user_id': user_id}:\n            return f'User {user_id} logged out'\n        \n        case {'type': 'purchase', 'user_id': user_id, 'amount': amount} if amount > 100:\n            return f'Large purchase: User {user_id} spent ${amount}'\n        \n        case {'type': 'purchase', 'user_id': user_id, 'amount': amount}:\n            return f'Purchase: User {user_id} spent ${amount}'\n        \n        case {'type': 'error', 'message': message}:\n            return f'Error: {message}'\n        \n        case _:\n            return 'Unknown event'\n\ndef parse_command(command_string):\n    \"\"\"Parse command string using pattern matching.\"\"\"\n    parts = command_string.split()\n    \n    match parts:\n        case ['quit'] | ['exit']:\n            return 'Exiting program'\n        \n        case ['help']:\n            return 'Available commands: quit, help, add, list, delete'\n        \n        case ['add', *items] if items:\n            return f'Adding: {\", \".join(items)}'\n        \n        case ['add']:\n            return 'Error: add requires items'\n        \n        case ['delete', item_id] if item_id.isdigit():\n            return f'Deleting item #{item_id}'\n        \n        case ['delete', item_id]:\n            return f'Error: {item_id} is not a valid ID'\n        \n        case ['list']:\n            return 'Listing all items'\n        \n        case []:\n            return 'No command entered'\n        \n        case [cmd, *_]:\n            return f'Unknown command: {cmd}'\n\ndef process_api_response(response):\n    \"\"\"Process different API response structures.\"\"\"\n    match response:\n        case {'status': 'success', 'data': {'user': {'name': name, 'id': user_id}}}:\n            return f'User: {name} (ID: {user_id})'\n        \n        case {'status': 'success', 'data': {'users': users}} if len(users) > 0:\n            return f'Found {len(users)} users'\n        \n        case {'status': 'success', 'data': []}:\n            return 'No data found'\n        \n        case {'status': 'error', 'code': code, 'message': message}:\n            return f'Error {code}: {message}'\n        \n        case {'status': 'error', 'message': message}:\n            return f'Error: {message}'\n        \n        case _:\n            return 'Invalid response format'\n\ndef analyze_data_structure(data):\n    \"\"\"Analyze and describe data structure patterns.\"\"\"\n    match data:\n        case []:\n            return 'Empty list'\n        \n        case [single]:\n            return f'Single item: {single}'\n        \n        case [first, second]:\n            return f'Pair: {first}, {second}'\n        \n        case [first, *middle, last] if len(middle) > 0:\n            return f'List: first={first}, middle={len(middle)} items, last={last}'\n        \n        case {}:\n            return 'Empty dict'\n        \n        case {'type': t, 'value': v}:\n            return f'Typed value: {t} = {v}'\n        \n        case dict() as d if len(d) > 0:\n            return f'Dict with {len(d)} keys'\n        \n        case int(n) if n > 0:\n            return f'Positive integer: {n}'\n        \n        case int(n) if n < 0:\n            return f'Negative integer: {n}'\n        \n        case str(s):\n            return f'String: {s}'\n        \n        case _:\n            return 'Unknown structure'\n\ndef handle_user_action(action, user):\n    \"\"\"Handle user actions with pattern matching and guards.\"\"\"\n    match (action, user):\n        case ('login', {'username': username, 'password': password}) if username and password:\n            return f'Logging in user: {username}'\n        \n        case ('login', _):\n            return 'Error: Missing credentials'\n        \n        case ('post', {'role': 'admin', 'content': content}):\n            return f'Admin posting: {content[:50]}'\n        \n        case ('post', {'role': 'user', 'content': content}) if len(content) <= 280:\n            return f'User posting: {content}'\n        \n        case ('post', {'role': 'user', 'content': _}):\n            return 'Error: Post too long (max 280 chars)'\n        \n        case ('delete', {'role': 'admin', 'item_id': item_id}):\n            return f'Admin deleting item {item_id}'\n        \n        case ('delete', {'role': 'user'}):\n            return 'Error: Permission denied'\n        \n        case (act, _):\n            return f'Unknown action: {act}'\n\n# Test code as provided",
  "hints": [
    "Match-case syntax: match value: case pattern: ...",
    "Use guards with 'if': case pattern if condition:",
    "OR patterns: case 'a' | 'b' | 'c':",
    "Destructure lists: case [first, *middle, last]:",
    "Destructure dicts: case {'key': value, 'other': other}:",
    "Pattern matching requires Python 3.10 or higher"
  ],
  "testCases": [
    {
      "id": "tc1",
      "description": "Route login event",
      "input": "route_event({'type': 'user_login', 'user_id': 123})",
      "expectedOutput": "'User 123 logged in'",
      "isHidden": false
    },
    {
      "id": "tc2",
      "description": "Parse quit command",
      "input": "parse_command('quit')",
      "expectedOutput": "'Exiting program'",
      "isHidden": false
    },
    {
      "id": "tc3",
      "description": "Process success API response",
      "input": "'Alice' in process_api_response({'status': 'success', 'data': {'user': {'name': 'Alice', 'id': 1}}})",
      "expectedOutput": "True",
      "isHidden": false
    },
    {
      "id": "tc4",
      "description": "Analyze list with middle elements",
      "input": "'middle' in analyze_data_structure([1, 2, 3, 4, 5])",
      "expectedOutput": "True",
      "isHidden": true
    },
    {
      "id": "tc5",
      "description": "Admin can delete",
      "input": "'Admin deleting' in handle_user_action('delete', {'role': 'admin', 'item_id': 123})",
      "expectedOutput": "True",
      "isHidden": true
    },
    {
      "id": "tc6",
      "description": "User cannot delete",
      "input": "'Permission denied' in handle_user_action('delete', {'role': 'user'})",
      "expectedOutput": "True",
      "isHidden": true
    }
  ]
}