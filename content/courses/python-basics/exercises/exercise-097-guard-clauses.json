{
  "id": "exercise-097-guard-clauses",
  "lessonId": "lesson-089-guard-clauses",
  "title": "Payment Processor",
  "description": "Build a payment processing system that uses guard clauses to handle edge cases and validation early, keeping the main logic clean.\n\nYour program should:\n1. Use guard clauses for input validation\n2. Fail fast on invalid conditions\n3. Keep happy path logic at minimal nesting\n4. Return early from functions when conditions fail\n5. Make code more testable with clear guard patterns\n\nImplement these functions:\n- `process_payment(amount, card, user)`: Process payment with guards\n- `transfer_funds(from_account, to_account, amount)`: Transfer with validation\n- `apply_coupon(cart, coupon_code)`: Apply discount with checks\n- `create_account(username, email, password)`: Account creation with guards\n- `withdraw_funds(account, amount)`: Withdrawal with safety checks\n\nExample:\n```python\nresult = process_payment(100, {'number': '1234'}, {'id': 1})\n# Returns success or early error message\n```",
  "difficulty": "intermediate",
  "points": 20,
  "language": "python",
  "starterCode": "def process_payment(amount, card, user):\n    \"\"\"Process payment with guard clauses.\"\"\"\n    # TODO: Implement guards for:\n    # 1. Check amount is valid (> 0)\n    # 2. Check user exists and has 'id'\n    # 3. Check card exists and has 'number'\n    # 4. Check card number is valid (16 digits)\n    # 5. Check card has 'cvv' (3 digits)\n    # If all pass, return success message\n    # Return error message for each guard that fails\n    \n    pass\n\ndef transfer_funds(from_account, to_account, amount):\n    \"\"\"Transfer funds between accounts with guards.\"\"\"\n    # TODO: Implement guards:\n    # 1. Check from_account exists\n    # 2. Check to_account exists\n    # 3. Check amount is positive\n    # 4. Check from_account has sufficient balance\n    # 5. Check accounts are different\n    # If valid: return success with new balances\n    # Otherwise: return error message\n    \n    pass\n\ndef apply_coupon(cart, coupon_code):\n    \"\"\"Apply coupon code to cart with validation guards.\"\"\"\n    # TODO: Implement guards:\n    # 1. Check cart exists and has 'total'\n    # 2. Check cart total > 0\n    # 3. Check coupon_code is not empty\n    # 4. Validate coupon (use simple dict for valid coupons):\n    #    'SAVE10': 10% off, 'SAVE20': 20% off, 'FREE50': $50 off\n    # 5. Check minimum purchase for percentage coupons (min $50)\n    # If valid: return dict with discount and new total\n    # Otherwise: return error\n    \n    pass\n\ndef create_account(username, email, password):\n    \"\"\"Create account with comprehensive validation guards.\"\"\"\n    # TODO: Implement guards:\n    # 1. Check username is not empty\n    # 2. Check username length (3-20 chars)\n    # 3. Check email is not empty\n    # 4. Check email format (contains '@' and '.')\n    # 5. Check password is not empty\n    # 6. Check password length (min 8 chars)\n    # 7. Check password has uppercase, lowercase, and digit\n    # Return: {'success': True, 'user_id': 12345} or error dict\n    \n    pass\n\ndef withdraw_funds(account, amount):\n    \"\"\"Withdraw funds with safety guards.\"\"\"\n    # TODO: Implement guards:\n    # 1. Check account exists\n    # 2. Check account is active (has 'active': True)\n    # 3. Check amount is positive\n    # 4. Check amount is not too small (min $1)\n    # 5. Check amount is not too large (max $1000 per transaction)\n    # 6. Check sufficient balance\n    # If valid: return new balance\n    # Otherwise: return error message\n    \n    pass\n\n# Test the functions\nprint(\"Payment Processing with Guards:\")\nprint(\"=\"*60)\npayment_tests = [\n    (100, {'number': '1234567890123456', 'cvv': '123'}, {'id': 1}),\n    (-50, {'number': '1234567890123456', 'cvv': '123'}, {'id': 1}),\n    (100, None, {'id': 1}),\n    (100, {'number': '1234567890123456', 'cvv': '123'}, None),\n    (100, {'number': '12345', 'cvv': '123'}, {'id': 1}),\n]\n\nfor amount, card, user in payment_tests:\n    result = process_payment(amount, card, user)\n    print(f\"Amount: ${amount}, Card: {card is not None}, User: {user is not None}\")\n    print(f\"Result: {result}\\n\")\n\nprint(\"=\"*60)\nprint(\"Fund Transfers:\")\nprint(\"=\"*60)\ntransfer_tests = [\n    ({'id': 1, 'balance': 500}, {'id': 2, 'balance': 200}, 100),\n    ({'id': 1, 'balance': 50}, {'id': 2, 'balance': 200}, 100),\n    (None, {'id': 2, 'balance': 200}, 100),\n    ({'id': 1, 'balance': 500}, {'id': 1, 'balance': 500}, 100),\n]\n\nfor from_acc, to_acc, amount in transfer_tests:\n    result = transfer_funds(from_acc, to_acc, amount)\n    print(f\"Transfer ${amount}:\")\n    print(f\"Result: {result}\\n\")\n\nprint(\"=\"*60)\nprint(\"Coupon Application:\")\nprint(\"=\"*60)\ncoupon_tests = [\n    ({'total': 100}, 'SAVE10'),\n    ({'total': 30}, 'SAVE20'),  # Below minimum\n    ({'total': 100}, 'INVALID'),\n    ({'total': 100}, 'FREE50'),\n]\n\nfor cart, coupon in coupon_tests:\n    result = apply_coupon(cart, coupon)\n    print(f\"Cart: ${cart.get('total', 0)}, Coupon: {coupon}\")\n    print(f\"Result: {result}\\n\")\n\nprint(\"=\"*60)\nprint(\"Account Creation:\")\nprint(\"=\"*60)\naccount_tests = [\n    ('alice', 'alice@example.com', 'Password123'),\n    ('ab', 'alice@example.com', 'Password123'),\n    ('alice', 'invalid-email', 'Password123'),\n    ('alice', 'alice@example.com', 'weak'),\n    ('alice', 'alice@example.com', 'nodigits'),\n]\n\nfor username, email, password in account_tests:\n    result = create_account(username, email, password)\n    print(f\"Username: {username}, Email: {email}\")\n    print(f\"Result: {result}\\n\")\n\nprint(\"=\"*60)\nprint(\"Fund Withdrawals:\")\nprint(\"=\"*60)\nwithdrawal_tests = [\n    ({'id': 1, 'balance': 500, 'active': True}, 100),\n    ({'id': 1, 'balance': 500, 'active': False}, 100),\n    ({'id': 1, 'balance': 500, 'active': True}, -50),\n    ({'id': 1, 'balance': 500, 'active': True}, 0.50),\n    ({'id': 1, 'balance': 500, 'active': True}, 1500),\n    ({'id': 1, 'balance': 50, 'active': True}, 100),\n]\n\nfor account, amount in withdrawal_tests:\n    result = withdraw_funds(account, amount)\n    print(f\"Withdraw ${amount} from account (balance: ${account.get('balance', 0)})\")\n    print(f\"Result: {result}\\n\")",
  "solution": "def process_payment(amount, card, user):\n    \"\"\"Process payment with guard clauses.\"\"\"\n    # Guard 1: Amount validation\n    if amount <= 0:\n        return 'Error: Amount must be positive'\n    \n    # Guard 2: User validation\n    if not user or 'id' not in user:\n        return 'Error: Invalid user'\n    \n    # Guard 3: Card validation\n    if not card or 'number' not in card:\n        return 'Error: Invalid card'\n    \n    # Guard 4: Card number length\n    if len(card['number']) != 16:\n        return 'Error: Card number must be 16 digits'\n    \n    # Guard 5: CVV validation\n    if 'cvv' not in card or len(card['cvv']) != 3:\n        return 'Error: Invalid CVV'\n    \n    # Happy path\n    return f'Payment of ${amount} processed successfully'\n\ndef transfer_funds(from_account, to_account, amount):\n    \"\"\"Transfer funds between accounts with guards.\"\"\"\n    # Guard: from account\n    if not from_account:\n        return 'Error: Source account invalid'\n    \n    # Guard: to account\n    if not to_account:\n        return 'Error: Destination account invalid'\n    \n    # Guard: same account\n    if from_account.get('id') == to_account.get('id'):\n        return 'Error: Cannot transfer to same account'\n    \n    # Guard: amount positive\n    if amount <= 0:\n        return 'Error: Amount must be positive'\n    \n    # Guard: sufficient funds\n    if from_account.get('balance', 0) < amount:\n        return 'Error: Insufficient funds'\n    \n    # Process transfer\n    new_from_balance = from_account['balance'] - amount\n    new_to_balance = to_account['balance'] + amount\n    return f'Transfer successful. New balances: From ${new_from_balance}, To ${new_to_balance}'\n\ndef apply_coupon(cart, coupon_code):\n    \"\"\"Apply coupon code to cart with validation guards.\"\"\"\n    # Guard: cart validation\n    if not cart or 'total' not in cart:\n        return 'Error: Invalid cart'\n    \n    # Guard: cart total\n    if cart['total'] <= 0:\n        return 'Error: Cart is empty'\n    \n    # Guard: coupon code\n    if not coupon_code:\n        return 'Error: No coupon code provided'\n    \n    # Valid coupons\n    COUPONS = {\n        'SAVE10': {'type': 'percent', 'value': 10, 'min_purchase': 50},\n        'SAVE20': {'type': 'percent', 'value': 20, 'min_purchase': 50},\n        'FREE50': {'type': 'fixed', 'value': 50, 'min_purchase': 0}\n    }\n    \n    # Guard: valid coupon\n    if coupon_code not in COUPONS:\n        return 'Error: Invalid coupon code'\n    \n    coupon = COUPONS[coupon_code]\n    \n    # Guard: minimum purchase\n    if cart['total'] < coupon['min_purchase']:\n        return f'Error: Minimum purchase ${coupon[\"min_purchase\"]} required'\n    \n    # Calculate discount\n    if coupon['type'] == 'percent':\n        discount = cart['total'] * (coupon['value'] / 100)\n    else:\n        discount = coupon['value']\n    \n    new_total = cart['total'] - discount\n    return {'discount': discount, 'new_total': new_total, 'success': True}\n\ndef create_account(username, email, password):\n    \"\"\"Create account with comprehensive validation guards.\"\"\"\n    # Guard: username empty\n    if not username:\n        return {'success': False, 'error': 'Username required'}\n    \n    # Guard: username length\n    if len(username) < 3 or len(username) > 20:\n        return {'success': False, 'error': 'Username must be 3-20 characters'}\n    \n    # Guard: email empty\n    if not email:\n        return {'success': False, 'error': 'Email required'}\n    \n    # Guard: email format\n    if '@' not in email or '.' not in email:\n        return {'success': False, 'error': 'Invalid email format'}\n    \n    # Guard: password empty\n    if not password:\n        return {'success': False, 'error': 'Password required'}\n    \n    # Guard: password length\n    if len(password) < 8:\n        return {'success': False, 'error': 'Password must be at least 8 characters'}\n    \n    # Guard: password strength\n    has_upper = any(c.isupper() for c in password)\n    has_lower = any(c.islower() for c in password)\n    has_digit = any(c.isdigit() for c in password)\n    \n    if not (has_upper and has_lower and has_digit):\n        return {'success': False, 'error': 'Password must contain uppercase, lowercase, and digit'}\n    \n    # Success\n    return {'success': True, 'user_id': 12345}\n\ndef withdraw_funds(account, amount):\n    \"\"\"Withdraw funds with safety guards.\"\"\"\n    # Guard: account exists\n    if not account:\n        return 'Error: Invalid account'\n    \n    # Guard: account active\n    if not account.get('active', False):\n        return 'Error: Account is not active'\n    \n    # Guard: amount positive\n    if amount <= 0:\n        return 'Error: Amount must be positive'\n    \n    # Guard: minimum amount\n    if amount < 1:\n        return 'Error: Minimum withdrawal is $1'\n    \n    # Guard: maximum amount\n    if amount > 1000:\n        return 'Error: Maximum withdrawal is $1000'\n    \n    # Guard: sufficient balance\n    if account.get('balance', 0) < amount:\n        return 'Error: Insufficient funds'\n    \n    # Process withdrawal\n    new_balance = account['balance'] - amount\n    return f'Withdrawal successful. New balance: ${new_balance}'\n\n# Test code as provided",
  "hints": [
    "Guard clauses check invalid conditions first and return immediately",
    "Each guard should check ONE condition and return ONE specific error",
    "Put guards at the start of the function before any main logic",
    "Happy path (success case) should come LAST with minimal nesting",
    "Make error messages specific: tell the user exactly what's wrong",
    "Test each guard independently for better code coverage"
  ],
  "testCases": [
    {
      "id": "tc1",
      "description": "Valid payment processes",
      "input": "process_payment(100, {'number': '1234567890123456', 'cvv': '123'}, {'id': 1})",
      "expectedOutput": "'Payment of $100 processed successfully'",
      "isHidden": false
    },
    {
      "id": "tc2",
      "description": "Negative amount rejected",
      "input": "'Error' in process_payment(-50, {'number': '1234567890123456', 'cvv': '123'}, {'id': 1})",
      "expectedOutput": "True",
      "isHidden": false
    },
    {
      "id": "tc3",
      "description": "Insufficient funds caught",
      "input": "'Error' in transfer_funds({'id': 1, 'balance': 50}, {'id': 2, 'balance': 200}, 100)",
      "expectedOutput": "True",
      "isHidden": false
    },
    {
      "id": "tc4",
      "description": "Valid coupon applies discount",
      "input": "apply_coupon({'total': 100}, 'SAVE10')['success']",
      "expectedOutput": "True",
      "isHidden": true
    },
    {
      "id": "tc5",
      "description": "Weak password rejected",
      "input": "create_account('alice', 'alice@example.com', 'weak')['success']",
      "expectedOutput": "False",
      "isHidden": true
    },
    {
      "id": "tc6",
      "description": "Inactive account blocks withdrawal",
      "input": "'Error' in withdraw_funds({'id': 1, 'balance': 500, 'active': False}, 100)",
      "expectedOutput": "True",
      "isHidden": true
    }
  ]
}