{
  "id": "exercise-094-complex-conditional-patterns",
  "lessonId": "lesson-086-complex-conditional-patterns",
  "title": "Business Rules Engine",
  "description": "Build a business rules engine that handles complex multi-condition logic using clean patterns and techniques.\n\nYour program should:\n1. Extract complex conditions into well-named variables\n2. Use lookup tables instead of long if-elif chains\n3. Implement state machines for complex workflows\n4. Apply multi-criteria decision making\n5. Build configuration-driven conditional logic\n\nImplement these functions:\n- `evaluate_loan_application(applicant)`: Multi-criteria scoring\n- `get_shipping_method(order)`: Lookup table approach\n- `process_order_state(order, action)`: State machine\n- `calculate_insurance_premium(driver)`: Complex scoring\n- `validate_with_rules(data, rules_config)`: Config-driven\n\nExample:\n```python\nresult = evaluate_loan_application({'income': 60000, 'credit': 720})\n# Returns score and decision\n```",
  "difficulty": "advanced",
  "points": 25,
  "language": "python",
  "starterCode": "def evaluate_loan_application(applicant):\n    \"\"\"Score loan application with multiple criteria.\"\"\"\n    # TODO: Calculate score based on:\n    # - income: >= 80k: 40pts, >= 50k: 30pts, >= 30k: 20pts, else: 10pts\n    # - credit_score: >= 750: 30pts, >= 700: 25pts, >= 650: 20pts, else: 10pts\n    # - employment_years: >= 5: 20pts, >= 3: 15pts, >= 1: 10pts, else: 5pts\n    # - debt_ratio: < 0.2: 10pts, < 0.4: 5pts, else: 0pts\n    # Return dict with score and decision:\n    # score >= 80: 'approved', >= 60: 'review', else: 'denied'\n    \n    pass\n\ndef get_shipping_method(order):\n    \"\"\"Get shipping method using lookup table.\"\"\"\n    # TODO: Instead of if-elif chain, use dictionary lookup\n    # Define SHIPPING_METHODS dict:\n    # 'express': {'cost': 20, 'days': 1}\n    # 'priority': {'cost': 10, 'days': 3}\n    # 'standard': {'cost': 5, 'days': 7}\n    # 'economy': {'cost': 2, 'days': 14}\n    # Return method info, or default to standard if invalid\n    \n    pass\n\ndef process_order_state(current_state, action):\n    \"\"\"State machine for order processing.\"\"\"\n    # TODO: Implement state transitions:\n    # States: 'pending', 'paid', 'shipped', 'delivered', 'cancelled'\n    # Transitions:\n    # pending + 'pay' -> 'paid'\n    # paid + 'ship' -> 'shipped'\n    # shipped + 'deliver' -> 'delivered'\n    # Any state + 'cancel' -> 'cancelled' (except delivered)\n    # Return new state or error message\n    \n    pass\n\ndef calculate_insurance_premium(driver):\n    \"\"\"Calculate car insurance premium with multiple factors.\"\"\"\n    # TODO: Base premium: $1000\n    # Age adjustments:\n    #   < 25: +50%, 25-65: no change, > 65: +25%\n    # Accidents:\n    #   0: -10%, 1: no change, 2+: +25% per accident\n    # Years licensed:\n    #   < 2: +30%, 2-5: +10%, > 5: -5%\n    # Vehicle type:\n    #   'sedan': no change, 'suv': +10%, 'sports': +50%\n    # Return final premium rounded to 2 decimals\n    \n    pass\n\ndef validate_with_rules(data, rules_config):\n    \"\"\"Validate data against configuration rules.\"\"\"\n    # TODO: rules_config is dict like:\n    # {\n    #   'age': {'min': 18, 'max': 100, 'required': True},\n    #   'email': {'required': True, 'must_contain': '@'},\n    #   'score': {'min': 0, 'max': 100, 'required': False}\n    # }\n    # Return tuple: (is_valid: bool, errors: list)\n    # Check each rule dynamically\n    \n    pass\n\ndef get_discount_tier(customer, purchase):\n    \"\"\"Determine discount tier with lookup pattern.\"\"\"\n    # TODO: Define discount tiers in config dict:\n    # platinum: member + purchase >= 1000 + loyalty >= 500\n    # gold: member + purchase >= 500 + loyalty >= 250\n    # silver: member + purchase >= 100\n    # bronze: member\n    # none: not member\n    # Return tier name and discount percentage\n    \n    pass\n\n# Test the functions\nprint(\"Loan Application Evaluation:\")\nprint(\"=\"*60)\napplicants = [\n    {'income': 90000, 'credit_score': 780, 'employment_years': 6, 'debt_ratio': 0.15},\n    {'income': 55000, 'credit_score': 710, 'employment_years': 3, 'debt_ratio': 0.25},\n    {'income': 35000, 'credit_score': 620, 'employment_years': 1, 'debt_ratio': 0.45},\n]\n\nfor i, app in enumerate(applicants, 1):\n    result = evaluate_loan_application(app)\n    print(f\"Applicant {i}: Score={result['score']}, Decision={result['decision']}\")\n\nprint(\"\\n\" + \"=\"*60)\nprint(\"Shipping Methods (Lookup Table):\")\nprint(\"=\"*60)\nmethods = ['express', 'priority', 'standard', 'invalid']\n\nfor method in methods:\n    order = {'shipping_method': method}\n    info = get_shipping_method(order)\n    print(f\"{method}: ${info['cost']}, {info['days']} days\")\n\nprint(\"\\n\" + \"=\"*60)\nprint(\"Order State Machine:\")\nprint(\"=\"*60)\nstate = 'pending'\nactions = ['pay', 'ship', 'deliver']\n\nfor action in actions:\n    state = process_order_state(state, action)\n    print(f\"After '{action}': {state}\")\n\n# Try invalid transition\nresult = process_order_state('delivered', 'cancel')\nprint(f\"Cancel delivered order: {result}\")\n\nprint(\"\\n\" + \"=\"*60)\nprint(\"Insurance Premium Calculation:\")\nprint(\"=\"*60)\ndrivers = [\n    {'age': 30, 'accidents': 0, 'years_licensed': 8, 'vehicle_type': 'sedan'},\n    {'age': 22, 'accidents': 1, 'years_licensed': 3, 'vehicle_type': 'sports'},\n    {'age': 70, 'accidents': 2, 'years_licensed': 50, 'vehicle_type': 'suv'},\n]\n\nfor i, driver in enumerate(drivers, 1):\n    premium = calculate_insurance_premium(driver)\n    print(f\"Driver {i} (age {driver['age']}, {driver['vehicle_type']}): ${premium}\")\n\nprint(\"\\n\" + \"=\"*60)\nprint(\"Config-Driven Validation:\")\nprint(\"=\"*60)\nrules = {\n    'age': {'min': 18, 'max': 100, 'required': True},\n    'email': {'required': True, 'must_contain': '@'},\n    'score': {'min': 0, 'max': 100, 'required': False}\n}\n\ntest_data = [\n    {'age': 25, 'email': 'test@example.com', 'score': 85},\n    {'age': 15, 'email': 'invalid-email', 'score': 50},\n    {'email': 'user@test.com'},\n]\n\nfor i, data in enumerate(test_data, 1):\n    valid, errors = validate_with_rules(data, rules)\n    print(f\"Data {i}: Valid={valid}, Errors={errors}\")\n\nprint(\"\\n\" + \"=\"*60)\nprint(\"Discount Tier Determination:\")\nprint(\"=\"*60)\ncustomers = [\n    {'is_member': True, 'purchase_total': 1500, 'loyalty_points': 600},\n    {'is_member': True, 'purchase_total': 600, 'loyalty_points': 300},\n    {'is_member': True, 'purchase_total': 150, 'loyalty_points': 50},\n    {'is_member': False, 'purchase_total': 1000, 'loyalty_points': 0},\n]\n\nfor i, customer in enumerate(customers, 1):\n    tier, discount = get_discount_tier(customer, customer['purchase_total'])\n    print(f\"Customer {i}: Tier={tier}, Discount={discount}%\")",
  "solution": "def evaluate_loan_application(applicant):\n    \"\"\"Score loan application with multiple criteria.\"\"\"\n    score = 0\n    \n    # Income scoring\n    income = applicant.get('income', 0)\n    if income >= 80000:\n        score += 40\n    elif income >= 50000:\n        score += 30\n    elif income >= 30000:\n        score += 20\n    else:\n        score += 10\n    \n    # Credit score\n    credit = applicant.get('credit_score', 0)\n    if credit >= 750:\n        score += 30\n    elif credit >= 700:\n        score += 25\n    elif credit >= 650:\n        score += 20\n    else:\n        score += 10\n    \n    # Employment years\n    years = applicant.get('employment_years', 0)\n    if years >= 5:\n        score += 20\n    elif years >= 3:\n        score += 15\n    elif years >= 1:\n        score += 10\n    else:\n        score += 5\n    \n    # Debt ratio\n    debt_ratio = applicant.get('debt_ratio', 1.0)\n    if debt_ratio < 0.2:\n        score += 10\n    elif debt_ratio < 0.4:\n        score += 5\n    \n    # Decision\n    if score >= 80:\n        decision = 'approved'\n    elif score >= 60:\n        decision = 'review'\n    else:\n        decision = 'denied'\n    \n    return {'score': score, 'decision': decision}\n\ndef get_shipping_method(order):\n    \"\"\"Get shipping method using lookup table.\"\"\"\n    SHIPPING_METHODS = {\n        'express': {'cost': 20, 'days': 1},\n        'priority': {'cost': 10, 'days': 3},\n        'standard': {'cost': 5, 'days': 7},\n        'economy': {'cost': 2, 'days': 14}\n    }\n    \n    method = order.get('shipping_method', 'standard')\n    return SHIPPING_METHODS.get(method, SHIPPING_METHODS['standard'])\n\ndef process_order_state(current_state, action):\n    \"\"\"State machine for order processing.\"\"\"\n    TRANSITIONS = {\n        ('pending', 'pay'): 'paid',\n        ('paid', 'ship'): 'shipped',\n        ('shipped', 'deliver'): 'delivered',\n        ('pending', 'cancel'): 'cancelled',\n        ('paid', 'cancel'): 'cancelled',\n        ('shipped', 'cancel'): 'cancelled',\n    }\n    \n    if action == 'cancel' and current_state == 'delivered':\n        return 'Error: Cannot cancel delivered order'\n    \n    new_state = TRANSITIONS.get((current_state, action))\n    if new_state:\n        return new_state\n    \n    return f'Error: Invalid action {action} for state {current_state}'\n\ndef calculate_insurance_premium(driver):\n    \"\"\"Calculate car insurance premium with multiple factors.\"\"\"\n    premium = 1000.0\n    \n    # Age adjustment\n    age = driver.get('age', 30)\n    if age < 25:\n        premium *= 1.5\n    elif age > 65:\n        premium *= 1.25\n    \n    # Accidents\n    accidents = driver.get('accidents', 0)\n    if accidents == 0:\n        premium *= 0.9\n    elif accidents >= 2:\n        premium *= (1 + 0.25 * accidents)\n    \n    # Years licensed\n    years_licensed = driver.get('years_licensed', 0)\n    if years_licensed < 2:\n        premium *= 1.3\n    elif years_licensed <= 5:\n        premium *= 1.1\n    else:\n        premium *= 0.95\n    \n    # Vehicle type\n    vehicle_type = driver.get('vehicle_type', 'sedan')\n    if vehicle_type == 'suv':\n        premium *= 1.1\n    elif vehicle_type == 'sports':\n        premium *= 1.5\n    \n    return round(premium, 2)\n\ndef validate_with_rules(data, rules_config):\n    \"\"\"Validate data against configuration rules.\"\"\"\n    errors = []\n    \n    for field, rules in rules_config.items():\n        # Check required\n        if rules.get('required', False) and field not in data:\n            errors.append(f\"{field} is required\")\n            continue\n        \n        # If field not present and not required, skip other checks\n        if field not in data:\n            continue\n        \n        value = data[field]\n        \n        # Check min\n        if 'min' in rules and value < rules['min']:\n            errors.append(f\"{field} must be >= {rules['min']}\")\n        \n        # Check max\n        if 'max' in rules and value > rules['max']:\n            errors.append(f\"{field} must be <= {rules['max']}\")\n        \n        # Check must_contain (for strings)\n        if 'must_contain' in rules and isinstance(value, str):\n            if rules['must_contain'] not in value:\n                errors.append(f\"{field} must contain '{rules['must_contain']}'\")\n    \n    return (len(errors) == 0, errors)\n\ndef get_discount_tier(customer, purchase):\n    \"\"\"Determine discount tier with lookup pattern.\"\"\"\n    is_member = customer.get('is_member', False)\n    loyalty = customer.get('loyalty_points', 0)\n    \n    if not is_member:\n        return ('none', 0)\n    \n    if purchase >= 1000 and loyalty >= 500:\n        return ('platinum', 20)\n    elif purchase >= 500 and loyalty >= 250:\n        return ('gold', 15)\n    elif purchase >= 100:\n        return ('silver', 10)\n    else:\n        return ('bronze', 5)\n\n# Test code continues as in starter...",
  "hints": [
    "Extract complex conditions to named variables for readability",
    "Use dictionary lookups instead of long if-elif chains when possible",
    "State machines work well with tuple keys: (current_state, action) -> new_state",
    "For scoring systems, accumulate points from different criteria",
    "Config-driven validation: loop through rules and check each dynamically",
    "Calculate adjustments as multipliers (1.5 = 150%, 0.9 = 90%)"
  ],
  "testCases": [
    {
      "id": "tc1",
      "description": "Strong applicant gets approved",
      "input": "evaluate_loan_application({'income': 90000, 'credit_score': 780, 'employment_years': 6, 'debt_ratio': 0.15})['decision']",
      "expectedOutput": "'approved'",
      "isHidden": false
    },
    {
      "id": "tc2",
      "description": "Shipping lookup returns correct info",
      "input": "get_shipping_method({'shipping_method': 'express'})['cost']",
      "expectedOutput": "20",
      "isHidden": false
    },
    {
      "id": "tc3",
      "description": "State machine transitions correctly",
      "input": "process_order_state('pending', 'pay')",
      "expectedOutput": "'paid'",
      "isHidden": false
    },
    {
      "id": "tc4",
      "description": "Young driver with sports car pays more",
      "input": "calculate_insurance_premium({'age': 22, 'accidents': 0, 'years_licensed': 3, 'vehicle_type': 'sports'}) > 1500",
      "expectedOutput": "True",
      "isHidden": true
    },
    {
      "id": "tc5",
      "description": "Validation catches missing required field",
      "input": "validate_with_rules({}, {'age': {'required': True}})[0]",
      "expectedOutput": "False",
      "isHidden": true
    },
    {
      "id": "tc6",
      "description": "Platinum tier for high purchase and loyalty",
      "input": "get_discount_tier({'is_member': True, 'loyalty_points': 600}, 1500)[0]",
      "expectedOutput": "'platinum'",
      "isHidden": true
    }
  ]
}